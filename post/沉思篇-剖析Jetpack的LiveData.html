<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.101.0"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="沉思篇-剖析Jetpack的LiveData"><meta itemprop=description content="沉思篇-剖析Jetpack的LiveData"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://hongui.github.io/imgs/hugo_next_avatar.png"><meta itemprop=keywords content="Android,Jetpack,沉思篇,源码剖析"><meta property="og:type" content="article"><meta property="og:title" content="沉思篇-剖析Jetpack的LiveData"><meta property="og:description" content="沉思篇-剖析Jetpack的LiveData"><meta property="og:image" content="/imgs/hugo_next_avatar.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://hongui.github.io/post/%E6%B2%89%E6%80%9D%E7%AF%87-%E5%89%96%E6%9E%90Jetpack%E7%9A%84LiveData.html"><meta property="og:site_name" content="低头沉思"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="hongui"><meta property="article:published_time" content="2021-03-23 18:14:09 +0800 +0800"><meta property="article:modified_time" content="2021-03-23 18:14:09 +0800 +0800"><link rel=stylesheet href=//unpkg.com/@fortawesome/fontawesome-free@6.1.1/css/all.min.css><link rel=stylesheet href=//unpkg.com/animate.css@3.1.1/animate.min.css><link rel=stylesheet href=/css/main.min.019b9abdfca3d87a72a5f512dc907d88e32f584e4ef2510e25b90e192969b786.css><style type=text/css>.post-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script id=LA_COLLECT src=https://sdk.51.la/js-sdk-pro.min.js></script>
<script>LA.init({id:"",ck:"",autoTrack:!0})</script><title>沉思篇-剖析Jetpack的LiveData - 低头沉思</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏 role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>低头沉思</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>保持思考</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/posts/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>14</span></a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#livedata的功能>LiveData的功能</a><ul><li><a href=#livedata的数据容器功能>LiveData的数据容器功能</a></li><li><a href=#livedata的生命周期感知>LiveData的生命周期感知</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=hongui src=/imgs/hugo_next_avatar.png><p class=site-author-name itemprop=name>hongui</p><div class=site-description itemprop=description>记录生活所思所见。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/posts/><span class=site-state-item-count>14</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>7</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>17</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/hongui title="Github → https://github.com/hongui" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/cc/small/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=back-to-top role=button aria-label=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a>
<a href=https://github.com/hongui rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://hongui.github.io/post/%E6%B2%89%E6%80%9D%E7%AF%87-%E5%89%96%E6%9E%90Jetpack%E7%9A%84LiveData.html><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=name content="hongui"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="hongui"><meta itemprop=description content="记录生活所思所见。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="沉思篇-剖析Jetpack的LiveData"><meta itemprop=description content="沉思篇-剖析Jetpack的LiveData"></span><header class=post-header><h1 class=post-title itemprop="name headline">沉思篇-剖析Jetpack的LiveData</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text>发表于：</span>
<time title="发表于：2021-03-23 18:14:09 +0800 +0800" itemprop="dateCreated datePublished" datetime="2021-03-23 18:14:09 +0800 +0800">2021-03-23</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text>分类于：</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90 itemprop=url rel=index><span itemprop=name>源码剖析</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>字数：</span><span>26</span></span>
<span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>阅读：&ap;</span>
<span>1分钟</span></span>
<span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i></span>
<span class=post-meta-item-text>浏览：</span>
<span class=waline-pageview-count data-path=/post/%E6%B2%89%E6%80%9D%E7%AF%87-%E5%89%96%E6%9E%90Jetpack%E7%9A%84LiveData.html><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><blockquote><p>上一篇我们讲到了架构组件中的Lifecycle，由于缺少具体的运用，可能缺少直观的感受，今天我们就用Lifecycle实战一回，看看Lifecycle是怎样运用到LiveData中的。</p></blockquote><h1 id=livedata的功能>LiveData的功能</h1><p>根据<code>LiveData</code>的类注释，我们可以知道，<code>LiveData</code>是一个实现了观察者模式的数据容器，并且是可感知生命周期的。由这个功能描述，我们就能知道<code>LiveData</code>是由两部分功能合并而来的，一部分是数据容器，一部分是响应生命周期。在阅读源码的时候，我觉得功能拆解是个很有用的手段，合理的功能拆解，就是有目的的省略，有助于快速理清功能实现逻辑。
接下来，我将以这两个功能为突破点，逐一梳理<code>LiveData</code>的实现思路。</p><h2 id=livedata的数据容器功能>LiveData的数据容器功能</h2><p>数据容器的概念相信大家不会陌生，几乎每种语言都会有他们的身影，开发者用它们来保存数据对象。由于应用场景的不同，出现了各种各样的数据容器，如<code>List</code>,<code>Set</code>这些是保存数据集的，<code>ThreadLocal</code>是保存线程私有数据的。那么<code>LiveData</code>是保存什么数据的呢，它是保存可观察数据的。
对于数据容器的拆解，其实是有固定的模式可寻的，就是以添加数据为突破口，然后以数据流向为主线，逐步击破。所以我们就从<code>LiveData</code>添加数据的方法<code>setValue</code>开始分析。</p><ol><li><code>setValue</code>方法的逻辑很少，主要就是两个，增加mVersion的版本，保存数据，然后就是调用<code>dispatchingValue</code>进行分发了。<code>mVersion</code>是个关键点，后面还会讲到，这里主要是混个脸熟。我们先进入到下一步。</li><li><code>dispatchingValue</code>的功能很清楚，从名字上就能看出来，就是分发数据的。但是它的实现却是很巧妙的。为了阐述这个实现，我们需要一个合适的场景。假设当前<code>LiveData</code>保存的数据变动频繁，并且观察对象很多的情况，我们怎样快速，准确地把数据传递给观察者呢？或者换种说法，当我们正在分发数据的时候，又有新数据来了怎么办？通常来说有两种方案，掐头去尾。掐头就是在数据更新的时候不管新数据，先把分发操作执行完之后再处理新数据。去尾就是新数据来了，取消上一次数据分发，重新分发新数据。<code>LiveData</code>采用的是去尾的方式。明白了这点，再看<code>dispatchingValue</code>就很清晰了，它用<code>mDispatchingValue</code>标识分发状态，用<code>mDispatchInvalidated</code>来标识新数据状态，然后在使用<code>for</code>循环分发数据的时候检测<code>mDispatchInvalidated</code>的状态是不是更新了，由此确定是不是需要取消此次分发，进行新一轮的分发。其他的就没有更多奥秘可言了。</li><li><code>considerNotify</code>是分发给具体的观察者之后的处理逻辑。这一步就是在步骤2中的<code>for</code>循环里完成的。所以这里就是数据的最后一站了。这个方法需要根据观察者的两个状态来确定是不是要通知。一个就是步骤1中提到的<code>mVersion</code>，因为观察者也有一份自己的<code>mLastVersion</code>,假如<code>mVersion</code>比<code>mLastVersion</code>小的话就没必要通知了，因为每次通知之后，它两的值是一样的。另一个就是和生命周期扯上关系的<code>mActive</code>了。这个状态标示着当前的观察者是否处于激活状态。假如不是，则直接返回了。搞了这两个判断之后就是简单的更新<code>mLastVersion</code>和执行<code>onChanged</code>回调了。
以上三步就是<code>LiveData</code>的数据更新过程，重点在于处理分发这个步骤上，在以后的项目中，我们可以借鉴这种思想，当然具体问题是需要具体分析的。
在上面的步骤3中我们知道了观察者的<code>mActive</code>是决定<code>LiveData</code>响应生命周期的关键，那么接下来我们来看看这个状态是怎么更新的吧。</li></ol><h2 id=livedata的生命周期感知>LiveData的生命周期感知</h2><p>联系上一篇文章沉思篇-剖析JetPack的<code>Lifecycle</code>,我们知道<code>Lifecycle</code>是专业干介个的（生命周期感知）。同时文章也提到了<code>Lifecycle</code>三个很重要的抽象，<code>LifecycleOwner</code>，<code>Lifecycle</code>，<code>LifecycleObserver</code>，这是引入生命周期感知三个很好的突破口。</p><ul><li><code>LifecycleOwner</code>作为生命周期的动力源，是直接可以获得Lifecycle的，继而可以方便地读取状态和注册状态监听，由于出色的接口封装，不需要和其他类产生耦合，是个很好的引入对象。</li><li><code>Lifecycle</code>作为<code>Lifecycle</code>的核心类，它完成了很多功能，是抽象类，只能继承使用。</li><li><code>LifecycleObserver</code>，作为状态更新通知的最后一环，可以很方便地完成状态监听，但是需要注册到合适的<code>Lifecycle</code>上。</li></ul><p>所以很显然，<code>LiveData</code>使用<code>Lifecycle</code>需要搞一个<code>LifecycleOwner</code>，用于引入生命周期的状态，还需要搞一个<code>LifecycleObserver</code>，用于响应状态更新。另外，由于我们是数据容器的定位，我们的数据是很可能供给给很多类使用的，所以假如将<code>LifecycleOwner</code>和<code>LiveData</code>绑定的话，一旦某个操作致使<code>LiveData</code>失活，其他所有的观察者就一摸黑了，啥也收不到了，这是有悖设计的。基于这个原因，<code>LifecycleOwner</code>只能和<code>Observer</code>绑定。结果就显而易见了，他们同时出现在了<code>observe</code>方法里，这也就解释了<code>observe</code>方法为啥需要两个参数。
很明显<code>observe</code>就是分析生命周期感知的突破口，我们再接再励，看看他们是怎么合力工作的。</p><p>在<code>observe</code>内部，<code>LifecycleOwner</code>和<code>Observer</code>同时被<code>LifecycleBoundObserver</code>接收，用于构造对象了，逻辑继续转到<code>LifecycleBoundObserver</code>中.</p><p>注意到<code>LifecycleBoundObserver</code>是实现了<code>LifecycleEventObserver</code>,并且继承自<code>ObserverWrapper</code>。<code>ObserverWrapper</code>不熟悉我们先放一边，上一篇中我们知道了<code>LifecycleEventObserver</code>是继承自<code>LifecycleObserver</code>的，它只有一个状态变更的回调。很显然，我们下一步就是去看看它是怎样处理状态变更的。</p><p>来到<code>onStateChanged</code>方法，里面做了两件事，而且是互斥的，这就是说，其实它在某种条件下干一件事，其他条件干另一个事。先看简单的一件事，它在<code>Lifecycle</code>状态是<code>DESTROYED``的时候移除了</code>Observer<code>，没有更多了。那么另一件事其实我们也能猜到了，就是状态不为</code>DESTROYED<code>的时候怎么搞。它委托给了父类</code>ObserverWrapper`搞。</p><p>逻辑来到<code>ObserverWrapper</code>的<code>activeStateChanged</code>方法里，里面就是对<code>LiveData</code>的状态进行设置而已，也就是根据现在是不是激活状态更新<code>mActiveCount</code>的值，并且在适当的条件下通知<code>LiveData</code>进入激活状态或者失活状态。另外就是上面我们心心念念的<code>mActive</code>了，这就接上了。当然，还有个极为关键的点，在激活状态下，会以自身为参数，进行一次数据数据，在某种情况下，这可能会引入数据问题。</p><p>到这里，<code>LiveData</code>的生命周期感知就看完了.一句话就能总结，<code>Lifecycle</code>让<code>LiveData</code>有了在激活状态下分发数据，在失活后自动取消监听的能力。</p><p>补充说明
虽然前面讲了那么多，还有一些内容是没有讲到的，比如数据的异步更新，<code>Observer</code>的注册过程，等等，但是已经不妨碍我们理解主流程了。为了加深印象，我还整理一个UML图，可以对照着图再次理解，回顾。
<img src=livedata.webp alt="livedata UML"></p></div><footer class=post-footer><div class=post-tags><a href=/tags/android>Android</a>
<a href=/tags/jetpack>Jetpack</a>
<a href=/tags/%e6%b2%89%e6%80%9d%e7%af%87>沉思篇</a>
<a href=/tags/%e6%ba%90%e7%a0%81%e5%89%96%e6%9e%90>源码剖析</a></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right><ul><li class=post-copyright-title><strong>文章标题：</strong>
沉思篇-剖析Jetpack的LiveData</li><li class=post-copyright-author><strong>原文作者：</strong>
hongui</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://hongui.github.io/post/%E6%B2%89%E6%80%9D%E7%AF%87-%E5%89%96%E6%9E%90Jetpack%E7%9A%84LiveData.html title=沉思篇-剖析Jetpack的LiveData>https://hongui.github.io/post/%E6%B2%89%E6%80%9D%E7%AF%87-%E5%89%96%E6%9E%90Jetpack%E7%9A%84LiveData.html</a></li><li class=post-copyright-license><strong>版权声明：</strong>
本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=https://hongui.github.io/post/%E6%B2%89%E6%80%9D%E7%AF%87-%E5%89%96%E6%9E%90Jetpack%E7%9A%84LiveData.html rel=next title=沉思篇-剖析Jetpack的ViewModel><i class="fa fa-chevron-left"></i> 沉思篇-剖析Jetpack的ViewModel</a></div><div class="post-nav-prev post-nav-item"><a href=https://hongui.github.io/post/%E6%B2%89%E6%80%9D%E7%AF%87-%E5%89%96%E6%9E%90JetPack%E7%9A%84Lifecycle.html rel=prev title=沉思篇-剖析JetPack的Lifecycle>沉思篇-剖析JetPack的Lifecycle
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2020 - 2022</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>hongui</span></div><div class=powered-by>由 <a href=https://gohugo.io target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=//unpkg.com/animejs@3.2.1/lib/anime.min.js defer></script>
<script type=text/javascript src=//unpkg.com/mathjax@3.2.0/es5/tex-mml-chtml.js defer></script>
<script type=text/javascript src=/js/hugo-next.min.21ad90f205eefb4437c327e9b6bb70a8bf15f6672cbf6ec080de32a2f39c2e31.js defer></script></body></html>