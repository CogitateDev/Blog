<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="rgb(255,255,255)"><title>Personal understanding and useage of CMake &#183; Deep thinking</title>
<meta name=title content="Personal understanding and useage of CMake &#183; Deep thinking"><script type=text/javascript src=/js/appearance.min.022d0ebc3b46a335eb1c7ef79b7f2de143d7cd5156d433638592ef1ce5f8554e.js integrity="sha256-Ai0OvDtGozXrHH73m38t4UPXzVFW1DNjhZLvHOX4VU4="></script><link type=text/css rel=stylesheet href=/css/main.bundle.min.2dd44849efa9d0ef68e8cdede2901f86dec79026811f5cf6b25aa2b8cd8ee63e.css integrity="sha256-LdRISe+p0O9o6M3t4pAfht7HkCaBH1z2slqiuM2O5j4="><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.f29ffdffd9ab4cc95250c3c7196b2d5dae8ee6ef0a4139451073f90183ae7e31.js integrity="sha256-8p/9/9mrTMlSUMPHGWstXa6O5u8KQTlFEHP5AYOufjE=" data-copy=Copy data-copied=Copied></script><meta name=description content="
      Personal understanding and useage of CMake
    "><link rel=canonical href=https://bravebuffalo.cc/en/post/Personal%20understanding%20and%20useage%20of%20CMake.html><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Personal understanding and useage of CMake"><meta property="og:description" content="Personal understanding and useage of CMake"><meta property="og:type" content="article"><meta property="og:url" content="https://bravebuffalo.cc/en/post/Personal%20understanding%20and%20useage%20of%20CMake.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-08-09T19:21:49+08:00"><meta property="article:modified_time" content="2021-08-09T19:21:49+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Personal understanding and useage of CMake"><meta name=twitter:description content="Personal understanding and useage of CMake"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Personal understanding and useage of CMake","headline":"Personal understanding and useage of CMake","description":"Personal understanding and useage of CMake","abstract":"Preface #CMake is a build tool, through which you can easily create cross-platform projects. It is usually used to build a project in two steps: generating a project file from the source code, and building the target product (which may be a dynamic library, a static library, or an executable program) from the project file.","inLanguage":"en","url":"https:\/\/bravebuffalo.cc\/en\/post\/Personal%20understanding%20and%20useage%20of%20CMake.html","author":{"@type":"Person","name":"Deep thinking"},"copyrightYear":"2021","dateCreated":"2021-08-09T19:21:49\u002b08:00","datePublished":"2021-08-09T19:21:49\u002b08:00","dateModified":"2021-08-09T19:21:49\u002b08:00","keywords":["Android","JNI","C/C++","CMake"],"mainEntityOfPage":"true","wordCount":"4758"}</script><meta name=author content="Deep thinking"><link href=mailto:honguilee@163.com rel=me><link href=https://github.com/hongui rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold pe-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral print:hidden sm:py-10"><nav class="flex items-start justify-between sm:items-center"><div class="flex flex-row items-center"><a href=/en/ class=mr-2><img src=/images/logo.png width=500 height=500 class="max-h-[10rem] max-w-[10rem] object-scale-down object-left" alt="Deep thinking">
</a><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/en/>Deep thinking</a></div><ul class="flex flex-col list-none text-end sm:flex-row"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/en/posts/ title=Posts><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Blog</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/en/categories/ title=Categories><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Categories</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/en/tags/ title=Tags><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Tags</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><button id=search-button-1 title="Search (/)">
<span class="transition-colors group-dark:hover:text-primary-400 group-hover:text-primary-600"><span class="relative inline-block align-text-bottom px-1 icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></button></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><div class="relative group"><button class="flex items-center justify-end w-full transition-colors group-dark:hover:text-primary-400 group-hover:text-primary-600">
<span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill="currentcolor" d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286H4.545zm1.634-.736L5.5 3.956h-.049l-.679 2.022H6.18z"/><path fill="currentcolor" d="M0 2a2 2 0 012-2h7a2 2 0 012 2v3h3a2 2 0 012 2v7a2 2 0 01-2 2H7a2 2 0 01-2-2v-3H2A2 2 0 010 9V2zm2-1A1 1 0 001 2v7a1 1 0 001 1h7a1 1 0 001-1V2A1 1 0 009 1H2zm7.138 9.995c.193.301.402.583.63.846-.748.575-1.673 1.001-2.768 1.292.178.217.451.635.555.867 1.125-.359 2.08-.844 2.886-1.494.777.665 1.739 1.165 2.93 1.472.133-.254.414-.673.629-.89-1.125-.253-2.057-.694-2.82-1.284.681-.747 1.222-1.651 1.621-2.757H14V8h-3v1.047h.765c-.318.844-.74 1.546-1.272 2.13a6.066 6.066.0 01-.415-.492 1.988 1.988.0 01-.94.31z"/></svg></span><span class=text-sm>EN</span><span class=text-[0.6rem]><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M233.4 406.6c12.5 12.5 32.8 12.5 45.3.0l192-192c12.5-12.5 12.5-32.8.0-45.3s-32.8-12.5-45.3.0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3.0s-12.5 32.8.0 45.3l192 192z"/></svg></span></span></button><div class="invisible w-full h-2 bg-transparent group-hover:visible"></div><div class="top-8 invisible absolute ltr:right-0 rtl:left-0 z-50 flex flex-col whitespace-nowrap rounded border border-neutral-300 bg-neutral text-start text-base shadow group-hover:visible dark:border-neutral-600 dark:bg-neutral-800"><div class="flex flex-grow"><a href=/post/CMake%E4%B8%AA%E4%BA%BA%E7%90%86%E8%A7%A3%E5%92%8C%E4%BD%BF%E7%94%A8.html class="w-full py-1 pe-10 ps-2 decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2">简体中文</a></div><div class="flex flex-grow"><a href=/en/post/Personal%20understanding%20and%20useage%20of%20CMake.html class="flex items-center justify-between w-full px-2 py-1 bg-primary-100 dark:bg-primary-900">English<span class="w-6 ms-2 text-primary-600 dark:text-primary-400"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M438.6 105.4c12.5 12.5 12.5 32.7.0 45.2l-256 256c-12.5 12.5-32.7 12.5-45.2.0L9.372 278.6c-12.496-12.5-12.496-32.7.0-45.2 12.498-12.5 32.758-12.5 45.258.0L159.1 338.7 393.4 105.4c12.5-12.52 32.7-12.52 45.2.0h0z"/></svg></span></span></a></div></div></div></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Personal understanding and useage of CMake</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2021-08-09 19:21:49 +0800 +0800">9 August 2021</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">23 mins</span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-prose grow"><h1 id=preface class="relative group">Preface <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#preface aria-label=Anchor>#</a></span></h1><p>CMake is a build tool, through which you can easily create cross-platform projects. It is usually used to build a project in two steps: generating a project file from the source code, and building the target product (which may be a dynamic library, a static library, or an executable program) from the project file. One of the main advantages of using CMake is that in the multi-platform or multi-people collaborative projects, developers can make their own preferences to make the choice of IDE, not subject to the influence of other people&rsquo;s project configuration, it is a bit like a cross-platform IDE, through which the configuration of the relevant settings, you can be in multiple platforms seamlessly, improve development efficiency.</p><h1 id=simplest-cmake-project class="relative group">Simplest CMake project <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#simplest-cmake-project aria-label=Anchor>#</a></span></h1><h2 id=project-setup class="relative group">Project setup <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#project-setup aria-label=Anchor>#</a></span></h2><p>A project managed with CMake will usually contain a <code>CMakeLists.txt</code> file in the project root directory, but of course subdirectories may also be present, which we&rsquo;ll talk about later. Let&rsquo;s start with the simplest project. Here is an example of the simplest project:</p><pre tabindex=0><code>CMakeProject
| CMakeLists.txt
| main.cpp
</code></pre><p>This is the complete runnable minimal project. In order, let&rsquo;s look at what&rsquo;s in the file</p><p><code>CMakeLists.txt</code></p><pre tabindex=0><code># Set the version number
cmake_minimum_required(VERSION 3.10)
# Set the project name
project(CMakeProject)
# Setting up product and source code associations
add_executable(${CMAKE_PROJECT_NAME} main.cpp)
</code></pre><p>Description:</p><ul><li>Commands in CMake are not case-sensitive</li><li>Comments beginning with `#'</li><li>Referencing variable syntax <code>${variable name}</code></li></ul><p>So there are really only three lines of valid content in the document.</p><ol><li><code>cmake_minimum_required(VERSION 3.10)</code> sets the minimum version supported by CMake. <code>VERSION</code> is the parameter name, followed by the version number. <strong>Note that the parameter name and parameters are separated by whitespace, not commas,</strong> or you will get an error.</li><li><code>project(CMakeProject)</code> CMake string can be with or without quotes, the effect is the same, this line is configured with the project name, such as the generation of Visual Studio project name is based on this name.</li><li><code>add_executable(${CMAKE_PROJECT_NAME} main.cpp)</code>
is the real management of the source code and the target product of the place, here we use the reference variable writing, and the file does not define the variable, that this variable exists in CMake, in CMake there are a lot of predefined variables, we can be directly referenced in this way, the above writing is the name of the project is set to the product of the name, of course, you can also fill in the string directly, to take another name is fine. The latter <code>main.cpp</code> is used to generate the source path of the product, which is the most flexible part of CMake. This is the most flexible part of CMake. <strong>The source path can be various, it can be found out, written directly, relative path, absolute path, etc.</strong> If you have more than one source code, you can use it. ** If you have more than one source code, you can separate them with blanks and write them in order.
In the configuration file above, we configured its source file as <code>main.cpp</code>, through which we want to generate an executable program with the same simple content:.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=o>&lt;&lt;</span><span class=s>&#34;hello CMake&#34;</span><span class=o>&lt;&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=project-compilation-and-execution class="relative group">Project compilation and execution <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#project-compilation-and-execution aria-label=Anchor>#</a></span></h2><p>Now that the preparations are done, we&rsquo;re going to use CMake to generate the executable.</p><p>The first step is of course to install CMake la, this is the download address <a href=https://cmake.org/download/ target=_blank rel=noreferrer>!Download</a>, according to their own platform to choose to download can be installed after the completion of the need to add it to the environment variables, so that we can easily use anywhere.
After installing CMake, open the command line tool and go to the root directory of the project you just created, i.e. to the directory where <code>CMakeLists.txt</code> and <code>main.cpp</code> are stored, and prepare to generate the project in the next step.</p><p>Usually in order not to affect and pollute the current working environment, we will choose to create a new directory to store the generated project files, the following I mainly Windows platform as the main platform to explain, other platforms are basically the same.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir build         <span class=c1># Create a folder to store the project files;</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> build            <span class=c1># Switch the cmake working directory.</span>
</span></span><span class=line><span class=cl>cmake ...           <span class=c1># Generate project files;</span>
</span></span></code></pre></div><p>After the execution of these three steps, we can see in the build folder has been generated inside a Visual Studio project, we can directly use Visual Studio to open the project, according to our habits to perform compilation and debugging. Of course, if you want to generate the fastest executable, I still recommend using CMake.</p><p>To perform a build with CMake, simply build on the previous step (i.e., you&rsquo;ve already successfully performed the three steps above) by executing another command <code>cmake --build . </code>and you&rsquo;re done. Remember to include the third period, which means that CMake builds in the current working directory.
If everything went well in the above four steps, then we can see the executable file named after the first parameter of <code>add_executable</code> in the <code>build/debug</code> directory (in this case <code>CMakeProject.exe</code>), and we can execute it by double-clicking or dragging it to the command line.</p><h2 id=extension-the-project class="relative group">Extension the project <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#extension-the-project aria-label=Anchor>#</a></span></h2><p>In the previous example, to generate the project file, we used two commands, in fact, here it can be done directly with one command - <code>cmake build -S . -B build</code>. The meaning of this command is to use the current path as the working path and the <code>build</code> directory as the build directory to generate the project file, that is, we don&rsquo;t need to create the <code>build</code> folder manually. The <code>-S</code> parameter configures the source path and <code>-B</code> configures the build path.</p><p>In addition, since CMake does not have a cleanup method, every time we change CMake&rsquo;s configuration (i.e., add or remove code from <code>CMakeLists.txt</code>) and need to regenerate the project file, we need to manually clean up the generated directory to make sure that it&rsquo;s empty; if we don&rsquo;t do this, the project may fail to be generated or the new configuration may not work. If you only change the source code, you don&rsquo;t need to regenerate the project, just do the fourth step.
Although the above operation is simple enough, but considering the long-term modification and validation needs, it is still too cumbersome and boring, especially to repeatedly switch the working directory, which is still rather annoying. So I recommend using batch processing to complete these operations. Combining the steps of cleaning up the generated directory and switching working directories, the final batch file may look like this</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>@echo off 
</span></span><span class=line><span class=cl>rd /s /q build
</span></span><span class=line><span class=cl>mkdir build
</span></span><span class=line><span class=cl><span class=nb>cd</span> build
</span></span><span class=line><span class=cl>cmake ...
</span></span><span class=line><span class=cl>cmake --build .
</span></span><span class=line><span class=cl><span class=nb>cd</span> debug
</span></span><span class=line><span class=cl>CMakeProject
</span></span><span class=line><span class=cl><span class=nb>cd</span> ... /...
</span></span></code></pre></div><p>Explain in order.</p><p>The first line turns off the command line&rsquo;s echo, because we don&rsquo;t want its echo to interfere with CMake&rsquo;s message output in a way that causes unnecessary confusion, and also because usually we only care if it ends up doing its job rather than looking at what it&rsquo;s doing.</p><p>The second line uses the Windows command for deleting folders (rmdir on Linux and MacOS), /s is to configure it to clear all the contents of the folder, including subfolders, without which the command will fail, and /q is to allow the command to execute the deletion directly without requiring us to manually confirm it, which is a very important parameter, as we would need to confirm the deletion of the folders one by one, completely defeating the purpose of automation. This parameter is very important, otherwise we need to confirm the deletion one by one, which completely defeats the purpose of automation. Then the next four sentences are what we talked about above, without further ado.</p><p>Coming all the way to the penultimate sentence, here I&rsquo;ve written the name of the executable directly (you need to replace it with your own), in order to run the executable directly after the compilation is complete, which is useful for some applications that generate files.</p><p>At the end of the execution, then cut the directory back to the root directory of the project, this is the role of the last line, because we compile again has switched the directory to the generated directory, and the compiled executable file is in the generated directory of the subdirectory, so back to the root directory, we need to fall back twice, this is to ensure that the next time we can triumph in the execution of the batch processing key.</p><p>Save the above as a file ending in bat, and then next time you can just type the bat file name at the command line to finish generating and building at once, it&rsquo;s just awesome.
This is all we need to know about CMake projects. Of course the actual project is far more complex than this, next I will use the pitfalls I have stepped on as a basis to increase the complexity of the project one by one, and slowly develop an understanding of CMake&rsquo;s workflow.</p><h1 id=multi-source-projects class="relative group">Multi-source projects <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#multi-source-projects aria-label=Anchor>#</a></span></h1><h2 id=personal-insights class="relative group">Personal insights <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#personal-insights aria-label=Anchor>#</a></span></h2><p>Before I start, let me talk about my understanding of the CMake project or <code>CMakeLists.txt</code> file. <strong>We can&rsquo;t understand a configuration in isolation, we need to categorize the commands and even distill its core working pattern. I am using the compilation and linking of c++ files as a clue to sort it out.</strong> We all know that for a c++ source file to generate executable code, it needs three steps</p><ul><li>Preprocessor processing, copying the contents of header files to source files, macro replacement, etc;</li><li>The compiler compiles the source files into .o object files;</li><li>The linker takes .o files and other libraries as input and links to generate executables.</li></ul><p>It is much easier to understand CMake along these lines. If CMake reports an error, we can use the information to find out which phase of CMake is causing the problem, and then quickly find a solution. In addition, we can also use this information to categorize the CMake configuration, my own understanding of the rough categorization is as follows.</p><ul><li>Configure CMake basic information: <code>cmake_minimum_required</code>;</li><li>Source code management: <code>file</code>, <code>aux_source_directory</code>;</li><li>Library-managed: <code>find_libraray</code>;</li><li>Header file management: <code>include_directories</code>;</li><li>For linkbase management: <code>link_directories</code>;</li><li>Sub-project management: <code>add_subdirectory</code>;</li><li>For generator management: <code>add_executable</code>, <code>add_library</code>;</li></ul><p>Of course, these are only a very small part of the picture, but they provide a better direction for understanding and searching for ideas to solve the problem.</p><h2 id=cmake-manages-subdirectories class="relative group">CMake manages subdirectories <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#cmake-manages-subdirectories aria-label=Anchor>#</a></span></h2><p>Many times we introduce third-party packages to reduce duplicate coding efforts, and usually such code we need to put in other directories, so I created a new subdirectory to simulate the stored third-party code. For this case, we have two forms of inclusion - sub-modules and sub-directories.</p><p>Let&rsquo;s start with the simpler subdirectories. A subdirectory means that the third-party code is treated as part of our code and is merged and compiled together, in a way that makes our project look more compact. For example, the following project structure</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>CMakeProject
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>|</span> auto.bat
</span></span><span class=line><span class=cl><span class=p>|</span> CMakeLists.txt    //Modify
</span></span><span class=line><span class=cl><span class=p>|</span> main.cpp          //modify
</span></span><span class=line><span class=cl><span class=p>|</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=se>\-</span>--3rd             //Added
</span></span><span class=line><span class=cl>        lib.h     
</span></span></code></pre></div><p>I created a new subfolder to simulate the third party code, now let&rsquo;s introduce it into <code>main.cpp</code>, compile it, and we&rsquo;ll see that an error is reported, with the message <code>fatal error C1083: Unable to open include file: "lib.h": No such file or directory,</code> which is normal. Combine this with the example I gave above. This error message is related to header files. Looking at the CMake documentation, I found out that CMake has an <code>include_directories</code> directive, which means to add the directory of the file header in order for CMake to find the header files. So I added <code>include_directories(3rd)</code> to the <code>CMakeLists.txt</code> file and ran the compile again and the project ran correctly. Take a look at the <code>main.cpp</code> at this point.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;lib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>a</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span><span class=n>b</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=o>&lt;&lt;</span><span class=s>&#34;hello CMake&#34;</span><span class=o>&lt;&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=o>&lt;&lt;</span><span class=s>&#34;a + b = &#34;</span><span class=o>&lt;&lt;</span><span class=n>sum</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=n>b</span><span class=p>)</span><span class=o>&lt;&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Note: There is a one-to-one correspondence between <code>include_directories</code> and <code>include</code> in the cpp, i.e., if the directory configured in <code>include_directories</code> is . (the current directory, CMake does not add the current directory to the <code>include</code> path), then the <code>include</code> of the corresponding cpp should be written in the form of <code>3rd/lib.h</code>, which simply means that <code>include_directories</code> is set to the root of the <code>include</code> directory.
The other case is submodules.</p><h2 id=cmake-management-submodule class="relative group">CMake management submodule <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#cmake-management-submodule aria-label=Anchor>#</a></span></h2><p>Submodule means that the module can be compiled separately and provided separately for other libraries to use, instead of being symbiotic with the main project, which applies to the case where the coupling with the main module is not too big. In order to satisfy this condition, we modify the directory structure to the following one</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>CMakeProject
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>|</span> auto.bat
</span></span><span class=line><span class=cl><span class=p>|</span> CMakeLists.txt        //Modify
</span></span><span class=line><span class=cl><span class=p>|</span> main.cpp        
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>|</span> 
</span></span><span class=line><span class=cl><span class=se>\-</span>3rd
</span></span><span class=line><span class=cl>        CMakeLists.txt  //added
</span></span><span class=line><span class=cl>        lib.cpp         //added
</span></span><span class=line><span class=cl>        lib.h           //modify
</span></span></code></pre></div><p>I changed the functions in <code>lib.h</code> to declarations, and the implementation is in the <code>lib.cpp</code> file. The biggest change was the creation of a new <code>CMakeLists.txt</code> file in the <code>3rd</code> directory, which manages all the source files in the <code>3rd</code> directory in a unified way (in case there are a lot of files, this is a simulation), and the use of <code>add_library</code> to package the <code>3rd</code> directory into sub-modules.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=nb>project</span><span class=p>(</span><span class=s>sum</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>add_library</span><span class=p>(</span><span class=o>${</span><span class=nv>PROJECT_NAME</span><span class=o>}</span> <span class=s>lib.cpp</span><span class=p>)</span><span class=err>
</span></span></span></code></pre></div><p><code>add_library</code> can also specify the build type between the name and the source code, the default is <code>STATIC</code>, which is a static library, if you want to build a dynamic library you need to manually specify <code>SHARED</code> (<code>add_library(${PROJECT_NAME} SHARED lib.cpp)</code>).</p><p>The important changes come from <code>CMakeLists.txt</code> in the main directory.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=c># Set the version number
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>cmake_minimum_required</span><span class=p>(</span><span class=s>VERSION</span> <span class=s>3.10</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Set the project name
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>project</span><span class=p>(</span><span class=s>CMakeProject</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Specify 3rd as the lookup directory for include
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>include_directories</span><span class=p>(</span><span class=s>3rd</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Submodules
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>add_subdirectory</span><span class=p>(</span><span class=s>3rd</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Setting up product and source code associations
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>add_executable</span><span class=p>(</span><span class=o>${</span><span class=nv>PROJECT_NAME</span><span class=o>}</span> <span class=s>main.cpp</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>target_link_libraries</span><span class=p>(</span><span class=o>${</span><span class=nv>PROJECT_NAME</span><span class=o>}</span> <span class=s>sum</span><span class=p>)</span><span class=err>
</span></span></span></code></pre></div><p>Added <code>add_subdirectory</code>, which is used to compile the source code from a specified directory as a module, provided there is a <code>CMakeLists.txt</code> file in that directory. Another change is the addition of <code>target_link_libraries</code>, which is used to link submodules into the main module; without it, linking would result in an error <code>error LNK2019: unresolved external symbol</code>. The name of the module needs to be the same as the first parameter of <code>add_library</code> in the submodule.</p><h1 id=cross-compilation class="relative group">Cross-compilation <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#cross-compilation aria-label=Anchor>#</a></span></h1><p>While the complexity of the project in the previous example was shown in the multiple directories and source code, the main complexity of the project in the process of cross-compiling with CMake is shown in the environment configuration. Although CMake can be used to cross-compile with little or no modification to <code>CMakeLists.txt</code>, newcomers are often overwhelmed by unfamiliar configurations and try to find an easy way to configure them with a single click. It is true that there is no such shortcut for CMake, but once we understand the essence of ** cross-compilation is the process of configuring property values correctly. However, once we understand that <strong>cross-compiling is the process of correctly configuring property values</strong>, the problem becomes clear. So, the questions above become familiar - what properties need to be configured, what are the appropriate values for those properties, how are those values passed to CMake, etc., and that&rsquo;s what cross-compilation is all about. As mentioned before, CMake has a lot of preset variables, and we need to find some of these preset variables, set some values, and then let CMake do its job according to these configurations, and that&rsquo;s what we need to do next. Below I will illustrate this process with an example of cross-compiling Android for Windows.</p><h2 id=prepare class="relative group">Prepare <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#prepare aria-label=Anchor>#</a></span></h2><p>On Windows platform, Visual Studio will be used as the compiler for C, C++ by default, which may report errors for compiling libraries for Android. So you need to use <code>-G "Unix Makefiles"</code> to change this behavior when executing <code>cmake</code> command. But that&rsquo;s not enough, because CMake compilation is required to specify the compiler. The C,C++ compiler on Android is usually provided in the form of NDK, so we need to download the NDK, which provides us with two tools at the same time, one is the compiler, and the other one is <code>android.toolchain.cmake</code>, which is also the file composed of CMake commands, which specifies a lot of preset values for cross-compilation, which can greatly simplify the compilation process. This is also a CMake file, which specifies a lot of presets for cross-compilation, which can greatly reduce our work.</p><h2 id=write-compilation-scripts class="relative group">Write compilation scripts <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#write-compilation-scripts aria-label=Anchor>#</a></span></h2><p>As mentioned earlier, cross-compiling is all about changing the CMake preset, and there are two ways to change this preset that we&rsquo;re going to use in combination. One is through the <code>android.toolchain.cmake</code> file provided by the NDK. The <code>android.toolchain.cmake</code> file sets most of the values, but it is also very flexible and has a lot of room for configuration. Therefore, depending on the user&rsquo;s needs, we also need to pass some values dynamically when executing CMake commands in order for CMake to do its job correctly. This is another way - options. Passing options will start with <code>-D</code> followed by some CMake predefined variable Since there are a lot of options and most of them are complex, it&rsquo;s better to document and modify them through script files. Below are just a few of the options that need to be specified to compile Android code on the Windows platform, and I&rsquo;ll go over the necessary configurations one by one.</p><ul><li><code>-DCMAKE_SYSTEM_NAME=Android</code> This configuration tells CMake that it needs to generate libraries for the Android platform, i.e., perform cross-compilation.</li><li>The <code>-DANDROID_ABI=x86</code> configuration tells CMake to generate libraries for the applicable architectural platforms. Readers familiar with Android development should not be unfamiliar with the supported values will change according to the changes in the NDK, such as the early <code>armeabi</code> has been removed in the NDK r17, now there are four mainstream <code>armeabi-v7a</code>, <code>arm64-v8a</code>, <code>x86</code>, <code>x86_64</code>. Just replace the values as needed.</li><li><code>-DANDROID_PLATFORM=android-28</code>, this value is not really necessary as there are preset values, but it is necessary to specify one for controllability. It is used to determine the minimum system version supported by the library.</li><li><code>-DCMAKE_TOOLCHAIN_FILE=C:/Users/Leroene/AppData/Local/Android/Sdk/ndk/21.0.6113669/build/cmake/android.toolchain.cmake</code>, which is the above mentioned preset file. Note that there are multiple files with this name in the NDK, and if you specify them incorrectly, you may get CMake errors, so my experience has been to change the version number (<code>C:/Users/Leroene/AppData/Local/Android/Sdk/ndk/21.0.6113669</code>) and the paths in front of it, and leave the paths behind it unchanged. The latter stays the same.</li><li><code>-DCMAKE_MAKE_PROGRAM=C:/Users/Leroene/AppData/Local/Android/Sdk/ndk/21.0.6113669/prebuilt/windows-x86_64/bin/make</code> The last argument specifies the path to the <code>make </code>program path, since we are specifying the code that generates the make project and Windows usually does not have a make executable, we need to let CMake find the make file in order to complete the compilation. My experience here is also to keep the later unchanged, modify the earlier, and keep the version consistent to avoid bugs.</li><li><code>-DCMAKE_BUILD_TYPE=Release</code> to specify the build type, which should be common enough.</li></ul><p>At this point all the configurations for cross compiling Android libraries for Windows have been explained. Let&rsquo;s have a look at its complete example</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>@echo off
</span></span><span class=line><span class=cl>rd /s /q build
</span></span><span class=line><span class=cl>mkdir build
</span></span><span class=line><span class=cl><span class=nb>cd</span> build
</span></span><span class=line><span class=cl>cmake -G <span class=s2>&#34;Unix Makefiles&#34;</span> ^
</span></span><span class=line><span class=cl>-DCMAKE_TOOLCHAIN_FILE<span class=o>=</span>C:/Users/Leroene/AppData/Local/Android/Sdk/ndk/21.0.6113669/build/cmake/android.toolchain.cmake ^
</span></span><span class=line><span class=cl>-DCMAKE_MAKE_PROGRAM<span class=o>=</span>C:/Users/Leroene/AppData/Local/Android/Sdk/ndk/21.0.6113669/prebuilt/windows-x86_64/bin/make ^
</span></span><span class=line><span class=cl>-DANDROID_PLATFORM<span class=o>=</span>android-28 ^
</span></span><span class=line><span class=cl>-DCMAKE_SYSTEM_NAME<span class=o>=</span>Android ^
</span></span><span class=line><span class=cl>-DANDROID_ABI<span class=o>=</span>x86 ^
</span></span><span class=line><span class=cl>-DCMAKE_BUILD_TYPE<span class=o>=</span>Release ^
</span></span><span class=line><span class=cl>... /3rd
</span></span><span class=line><span class=cl>cmake --build .
</span></span></code></pre></div><p>As you can see from the above, these options are all followed by a <code>^</code> symbol, which is not part of cmake, it is just written this way for our reading convenience, this is the command line break used for batch processing on Windows platform, its function is to tell the command parser that the command is not yet finished, and continue to be parsed down the line, this function is equivalent to <code>\</code> on Linux,MacOS This function corresponds to <code>\</code> on Linux and MacOS. Now that you have this configuration, how do you use it? It&rsquo;s quite easy, just store these commands in the <code>android.bat</code> file, switch to the current directory in CMD, execute this file and you&rsquo;ll find the static library file named <code>libsum.a</code> in the <code>build</code> directory. Next, let&rsquo;s try to run in the emulator with this library file.</p><h1 id=using-cmake-in-an-android-project class="relative group">Using CMake in an Android project <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#using-cmake-in-an-android-project aria-label=Anchor>#</a></span></h1><p>In the Android platform, CMake is also used to manage jni projects, along with Gradle to complete the build. The biggest difference between this and a normal CMake project is that we usually need to reference multiple Android related libraries such as <code>log</code>, <code>android</code>, etc. These libraries are usually provided by NDK. These libraries are usually provided by the NDK, and we can just follow the default <code>CMakeLists.txt</code> file.</p><h2 id=directory-structure class="relative group">Directory structure <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#directory-structure aria-label=Anchor>#</a></span></h2><p>Next, for descriptive purposes, let&rsquo;s take a look at the current directory structure (to avoid confusion, only the more representative files are listed here)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>CMakeProject
</span></span><span class=line><span class=cl>│ android.bat
</span></span><span class=line><span class=cl>│ CMakeLists.txt
</span></span><span class=line><span class=cl>│ main.cpp
</span></span><span class=line><span class=cl>│  
</span></span><span class=line><span class=cl>├óΓé¼╦£3rd
</span></span><span class=line><span class=cl>│ CMakeLists.txt
</span></span><span class=line><span class=cl>│ lib.cpp
</span></span><span class=line><span class=cl>│ lib.h
</span></span><span class=line><span class=cl>│   
</span></span><span class=line><span class=cl>└─Android
</span></span><span class=line><span class=cl>    │ build.gradle
</span></span><span class=line><span class=cl>    │   
</span></span><span class=line><span class=cl>    ├─app
</span></span><span class=line><span class=cl>    │ │ build.gradle
</span></span><span class=line><span class=cl>    │ │   
</span></span><span class=line><span class=cl>    │ ├─libs
</span></span><span class=line><span class=cl>    │ └─src         
</span></span><span class=line><span class=cl>    │ ├─main
</span></span><span class=line><span class=cl>    │ │ │ AndroidManifest.xml
</span></span><span class=line><span class=cl>    │ │ │  
</span></span><span class=line><span class=cl>    │ │ ├─cpp
</span></span><span class=line><span class=cl>    │ │ │ CMakeLists.txt
</span></span><span class=line><span class=cl>    │ │ │ native-lib.cpp
</span></span><span class=line><span class=cl>    │ │ │   
</span></span><span class=line><span class=cl>    │ │ ├─java
</span></span><span class=line><span class=cl>    │ │ └─me
</span></span><span class=line><span class=cl>    │ │ └─hongui
</span></span><span class=line><span class=cl>    │ │ └─cmakesum
</span></span><span class=line><span class=cl>    │ │ │ MainActivity.kt
</span></span><span class=line><span class=cl>    │ │ │   
</span></span><span class=line><span class=cl>    │ │ ├─jniLibs
</span></span><span class=line><span class=cl>    │ │ └─x86
</span></span><span class=line><span class=cl>    │ │ │ libsum.a
</span></span></code></pre></div><p>A new <code>Android</code> subdirectory has been created under the root of the original directory, which is an Android C++ project, so it has an extra <code>cpp</code> directory compared to other normal Android projects, and the main modifications we&rsquo;ll make later on happen in that directory.</p><p>The original root directory, in order not to add complexity, exists only as a function of generating static libraries, so there are no modifications compared to the example above.</p><h2 id=build-static-libraries class="relative group">Build static libraries <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#build-static-libraries aria-label=Anchor>#</a></span></h2><p>First, let&rsquo;s go back to the root directory. Use the <code>android.bat</code> batch in the root directory to generate static libraries that are available on Android, you can also modify the value of the <code>-DANDROID_ABI</code> option in the <code>android.bat</code> file to generate static libraries for other architectures, but this needs to correspond to the directories in the <code>jniLibs</code> directory, otherwise the link may fail. For example, the <code>libsum.a</code> file I generated is for the <code>x86</code> architecture. Then you need to create a new <code>x86</code> directory in the <code>jniLibs</code> directory, and then put <code>libsum.a</code> into that directory. This concludes the build of the static library.</p><h2 id=using-static-libraries class="relative group">Using static libraries <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#using-static-libraries aria-label=Anchor>#</a></span></h2><p>After putting the static libraries in place, we need to configure the <code>build.gradle</code> in the <code>app</code> directory and the <code>CMakeLists.txt</code> file in the <code>cpp</code> directory to complete the introduction of the static libraries.</p><h3 id=configuring-gradle class="relative group">Configuring Gradle <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#configuring-gradle aria-label=Anchor>#</a></span></h3><p>First, let&rsquo;s talk about <code>build.gradle</code>, which is mainly concerned with modifying the ABI, because if you don&rsquo;t specify it, the ABI generated by Gradle by default may not find the corresponding static library file to link to, which may lead to linking failure. The main changes in this file are as follows
<code>android {     defaultConfig {         externalNativeBuild {                 cmake {                     cppFlags ""                     abiFilters "x86"                 }             }     } }</code>
That is, specify the value of <code>abiFilters</code> as the same value as the static library you just built.</p><h3 id=configuring-cmake class="relative group">Configuring CMake <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#configuring-cmake aria-label=Anchor>#</a></span></h3><p>The <code>CMakeLists.txt</code> file is a bit more complicated, it needs to do two jobs, find the static libraries and static libraries&rsquo; header files, and link the static libraries.</p><h4 id=find-header-file class="relative group">find header file <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#find-header-file aria-label=Anchor>#</a></span></h4><p>In the second part of the article we already knew about the <code>include_directories</code> command that lets CMake find header files, just set the parameter to the <code>3rd</code> directory. It&rsquo;s worth noting that CMake uses the current <code>CMakeLists.txt</code> file as its working directory, so to specify to the <code>3rd</code> file we need to go all the way back in the directory to the root project, and end up with <code>include_directories(... /... /... /... /... /3rd)</code> configuration. Try to use relative paths, you can collaborate with multiple people without having to change the configuration.</p><h4 id=find-static-library class="relative group">find static library <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#find-static-library aria-label=Anchor>#</a></span></h4><p>The next step is to get CMake to find our static library. When it comes to libraries, it&rsquo;s all related to <code>add_library</code>, the difference is just the parameters. When adding a library using source, we need to specify the name and source location of the library, whereas to reference a third-party library, we need to specify the name and type of the library, plus an <code>IMPORTED</code> indicator parameter to tell CMake that the library is imported. So there is a configuration like <code>add_library(addSum STATIC IMPORTED)</code>.</p><p>However, here we have only told CMake the name of the library, where the library is stored is not yet known, so we need another command to tell CMake where the library is stored. When it comes to configuration parameters, it&rsquo;s usually the <code>set_target_properties</code> command, which can be called multiple times to set multiple configurations. <code>set_target_properties(addSum PROPERTIES IMPORTED_LOCATION ${CMAKE_CURRENT_SOURCE_DIR}/... /jniLibs/${ANDROID_ABI}/libsum.a)</code>, the first parameter and the first parameter of the previous entry are one-to-one and can be taken at will. In fact, <code>add_library</code> is equivalent to generating a target product, and the first parameter is used to refer to such a product, which is why our <code>set_target_properties</code> is allowed to find the appropriate target setting properties. The second parameter is the standard way to write a configuration property, the third represents the property variable, and the fourth is the value of the property. The variable that configures the library path is <code>IMPORTED_LOCATION</code>, and the value has a pitfall here, as CMake under Android restricts the value to an absolute path, not a relative path. This is contrary to the original purpose of using CMake, fortunately, we have a few preset values that we can use, <code>CMAKE_CURRENT_SOURCE_DIR</code> is one of them, it represents the absolute path of the current <code>CMakeLIsts.txt</code> file, with this, and the directory fallback function, we can find any appropriate directory. At this point, a second problem arises, when there are multiple architectures with static libraries to configure, we introduce different directories, and there is a lot of duplication of configurations. Luckily, it helps to have <code>ANDROID_ABI</code>, which refers to a certain architecture that is currently being compiled, and as the compilation progresses, this value is set to the appropriate value, and is a one-to-one correspondence with the architecture being compiled. So, even though they are a bit strange, this gives me flexibility and simplicity.</p><h4 id=linking-static-libraries class="relative group">Linking static libraries <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#linking-static-libraries aria-label=Anchor>#</a></span></h4><p>Now we have the header files and the libraries, but the compilation of C++ is divided into two steps, so far, our work has only done the compilation of things, not yet involved in the linking of things, of course, compared to the previous configuration, this is much simpler, undoubtedly is in the <code>target_link_libraries</code> command to add a parameter can be, such as</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=nb>target_link_libraries</span><span class=p>(</span> 
</span></span><span class=line><span class=cl><span class=s>  </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s>native-lib</span>
</span></span><span class=line><span class=cl><span class=s>  </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=o>${</span><span class=nv>log-lib</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=s>  </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s>addSum</span>
</span></span><span class=line><span class=cl><span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=s> </span> <span class=p>)</span><span class=err>
</span></span></span></code></pre></div><p>Just yo note that the name corresponds one to one with the name configured during <code>add_library</code>.</p><h3 id=use-in-source-code class="relative group">Use in source code <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#use-in-source-code aria-label=Anchor>#</a></span></h3><p>After a long wait, we are now able to introduce the <code>addsum</code> header file in the <code>native-lib.cpp</code> file and use the functions inside to get the job done. I intend for the function to return a string containing the result of the addition operation. The final implementation is as follows</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;jni.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;lib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=s>&#34;C&#34;</span> <span class=n>JNIEXPORT</span> <span class=n>jstring</span> <span class=n>JNICALL</span>
</span></span><span class=line><span class=cl><span class=n>Java_me_hongui_cmakesum_MainActivity_stringFromJNI</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>JNIEnv</span><span class=o>*</span> <span class=n>env</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>jobject</span> <span class=cm>/* this */</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>hello</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>sum</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>env</span><span class=o>-&gt;</span><span class=n>NewStringUTF</span><span class=p>(</span><span class=n>hello</span><span class=p>.</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>At this point, click the <code>run</code> button on the toolbar and we can finally see the results of our static library work in the Android emulator.</p><h2 id=extension class="relative group">Extension <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#extension aria-label=Anchor>#</a></span></h2><p>In fact, besides the way of referencing static libraries, we can also directly reference the source code by configuring the <code>CMakeLists.txt</code> file, which allows us to customize the source code anytime, anywhere, but it also slows down the compilation speed and may increase the complexity of <code>CMakeLists.txt</code>. So I still recommend the direct static library approach.</p><h1 id=summary class="relative group">Summary <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#summary aria-label=Anchor>#</a></span></h1><p>CMake in fact, there are many, many commands, we are involved here is only a very small part. However, I think that understanding CMake has these contents almost on it, the subsequent need to target learning on the line. Learning a technology, we must not be greedy, greedy for details. First of all, we must grasp the main, clear vein, the details of the latter is a matter of water to the drain. For CMake, I think it is the C++ code compiled into a binary process as the main trunk is enough. Where the source code comes from, where the header files are, where the library files are, how to organize the compilation, what libraries are involved in linking, what products are generated, and some general operations to complete these tasks, copying files ah, directory information ah, etc., a collection of these operations constitute the main body of CMake. In addition, CMake is really just a build tool, it is not a compiler or linker, and some problems may involve not only cmake, but also the compiler and linker. Of course, these are all issues that you may encounter later on, when you know more about it.</p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=flex><img class="!mb-0 !mt-0 me-4 h-24 w-24 rounded-full" width=96 height=96 alt="Deep thinking" src=/images/logo_hu9224ab2ed987e0d8e6ad569f112ae59a_19203_192x192_fill_box_center_3.png loading=lazy><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Deep thinking</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=mailto:honguilee@163.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://github.com/hongui target=_blank aria-label=Github rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span></span><span><a class="group flex text-right" href=/en/post/Introduction%20to%20Android%20NDK-basic%20concepts.html><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Introduction to Android NDK-basic concepts</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2022-03-06 11:30:40 +0800 +0800">6 March 2022</time>
</span></span><span class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&rarr;</span><span class="ltr:hidden rtl:inline">&larr;</span></span></a></span></div></div></footer></article><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2023
Deep thinking</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://github.com/jpanther/congo target=_blank rel="noopener noreferrer">Congo</a></p></div><div class="flex flex-row items-center"></div></div></footer><div id=search-wrapper class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://bravebuffalo.cc/en/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom px-1 icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>