<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="rgb(255,255,255)"><title>A introduction to Kotlin coroutine-from theory to practice &#183; Deep thinking</title>
<meta name=title content="A introduction to Kotlin coroutine-from theory to practice &#183; Deep thinking"><script type=text/javascript src=/js/appearance.min.022d0ebc3b46a335eb1c7ef79b7f2de143d7cd5156d433638592ef1ce5f8554e.js integrity="sha256-Ai0OvDtGozXrHH73m38t4UPXzVFW1DNjhZLvHOX4VU4="></script><link type=text/css rel=stylesheet href=/css/main.bundle.min.2dd44849efa9d0ef68e8cdede2901f86dec79026811f5cf6b25aa2b8cd8ee63e.css integrity="sha256-LdRISe+p0O9o6M3t4pAfht7HkCaBH1z2slqiuM2O5j4="><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.f29ffdffd9ab4cc95250c3c7196b2d5dae8ee6ef0a4139451073f90183ae7e31.js integrity="sha256-8p/9/9mrTMlSUMPHGWstXa6O5u8KQTlFEHP5AYOufjE=" data-copy=Copy data-copied=Copied></script><meta name=description content="
      A introduction to Kotlin coroutine-from theory to practice
    "><link rel=canonical href=https://bravebuffalo.cc/en/post/A%20introduction%20to%20Kotlin%20coroutine-from%20theory%20to%20practice.html><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="A introduction to Kotlin coroutine-from theory to practice"><meta property="og:description" content="A introduction to Kotlin coroutine-from theory to practice"><meta property="og:type" content="article"><meta property="og:url" content="https://bravebuffalo.cc/en/post/A%20introduction%20to%20Kotlin%20coroutine-from%20theory%20to%20practice.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-03-27T19:02:30+08:00"><meta property="article:modified_time" content="2021-03-27T19:02:30+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="A introduction to Kotlin coroutine-from theory to practice"><meta name=twitter:description content="A introduction to Kotlin coroutine-from theory to practice"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"A introduction to Kotlin coroutine-from theory to practice","headline":"A introduction to Kotlin coroutine-from theory to practice","description":"A introduction to Kotlin coroutine-from theory to practice","abstract":"The previous article partially explained Kotlin coroutines from a theoretical point of view, and this article will continue the journey of coroutines from a practical point of view, based on the previous article.\nFrom the source #In Kotlin, in order to use a coroutine, it first needs to be created using a co-creator, but there\u0026rsquo;s another prerequisite - a co-program scope (CoroutineScope).","inLanguage":"en","url":"https:\/\/bravebuffalo.cc\/en\/post\/A%20introduction%20to%20Kotlin%20coroutine-from%20theory%20to%20practice.html","author":{"@type":"Person","name":"Deep thinking"},"copyrightYear":"2021","dateCreated":"2021-03-27T19:02:30\u002b08:00","datePublished":"2021-03-27T19:02:30\u002b08:00","dateModified":"2021-03-27T19:02:30\u002b08:00","keywords":["Android","Kotlin","Coroutine"],"mainEntityOfPage":"true","wordCount":"1763"}</script><meta name=author content="Deep thinking"><link href=mailto:honguilee@163.com rel=me><link href=https://github.com/hongui rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold pe-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral print:hidden sm:py-10"><nav class="flex items-start justify-between sm:items-center"><div class="flex flex-row items-center"><a href=/en/ class=mr-2><img src=/images/logo.png width=500 height=500 class="max-h-[10rem] max-w-[10rem] object-scale-down object-left" alt="Deep thinking">
</a><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/en/>Deep thinking</a></div><ul class="flex flex-col list-none text-end sm:flex-row"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/en/posts/ title=Posts><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Blog</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/en/categories/ title=Categories><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Categories</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/en/tags/ title=Tags><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Tags</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">about</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><button id=search-button-1 title="Search (/)">
<span class="transition-colors group-dark:hover:text-primary-400 group-hover:text-primary-600"><span class="relative inline-block align-text-bottom px-1 icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></button></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><div class="relative group"><button class="flex items-center justify-end w-full transition-colors group-dark:hover:text-primary-400 group-hover:text-primary-600">
<span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill="currentcolor" d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286H4.545zm1.634-.736L5.5 3.956h-.049l-.679 2.022H6.18z"/><path fill="currentcolor" d="M0 2a2 2 0 012-2h7a2 2 0 012 2v3h3a2 2 0 012 2v7a2 2 0 01-2 2H7a2 2 0 01-2-2v-3H2A2 2 0 010 9V2zm2-1A1 1 0 001 2v7a1 1 0 001 1h7a1 1 0 001-1V2A1 1 0 009 1H2zm7.138 9.995c.193.301.402.583.63.846-.748.575-1.673 1.001-2.768 1.292.178.217.451.635.555.867 1.125-.359 2.08-.844 2.886-1.494.777.665 1.739 1.165 2.93 1.472.133-.254.414-.673.629-.89-1.125-.253-2.057-.694-2.82-1.284.681-.747 1.222-1.651 1.621-2.757H14V8h-3v1.047h.765c-.318.844-.74 1.546-1.272 2.13a6.066 6.066.0 01-.415-.492 1.988 1.988.0 01-.94.31z"/></svg></span><span class=text-sm>EN</span><span class=text-[0.6rem]><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M233.4 406.6c12.5 12.5 32.8 12.5 45.3.0l192-192c12.5-12.5 12.5-32.8.0-45.3s-32.8-12.5-45.3.0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3.0s-12.5 32.8.0 45.3l192 192z"/></svg></span></span></button><div class="invisible w-full h-2 bg-transparent group-hover:visible"></div><div class="top-8 invisible absolute ltr:right-0 rtl:left-0 z-50 flex flex-col whitespace-nowrap rounded border border-neutral-300 bg-neutral text-start text-base shadow group-hover:visible dark:border-neutral-600 dark:bg-neutral-800"><div class="flex flex-grow"><a href=/en/post/A%20introduction%20to%20Kotlin%20coroutine-from%20theory%20to%20practice.html class="flex items-center justify-between w-full px-2 py-1 bg-primary-100 dark:bg-primary-900">English<span class="w-6 ms-2 text-primary-600 dark:text-primary-400"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M438.6 105.4c12.5 12.5 12.5 32.7.0 45.2l-256 256c-12.5 12.5-32.7 12.5-45.2.0L9.372 278.6c-12.496-12.5-12.496-32.7.0-45.2 12.498-12.5 32.758-12.5 45.258.0L159.1 338.7 393.4 105.4c12.5-12.52 32.7-12.52 45.2.0h0z"/></svg></span></span></a></div><div class="flex flex-grow"><a href=/post/Kotlin%E5%8D%8F%E7%A8%8B-%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E5%AE%9E%E6%88%98.html class="w-full py-1 pe-10 ps-2 decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2">简体中文</a></div></div></div></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">A introduction to Kotlin coroutine-from theory to practice</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2021-03-27 19:02:30 +0800 +0800">27 March 2021</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">9 mins</span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-prose grow"><blockquote><p>The previous article partially explained Kotlin coroutines from a theoretical point of view, and this article will continue the journey of coroutines from a practical point of view, based on the previous article.</p></blockquote><h3 id=from-the-source class="relative group">From the source <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#from-the-source aria-label=Anchor>#</a></span></h3><p>In Kotlin, in order to use a coroutine, it first needs to be created using a co-creator, but there&rsquo;s another prerequisite - a co-program scope (<code>CoroutineScope</code>). In early Kotlin implementations, the coroutine creator was a first-class function, meaning that we could create a coroutine anytime, anywhere with the coroutine creator. However, after the official release of coroutines, the coroutine creator needs to be created on a coroutine scope object, and Kotlin added coroutine scopes to enable structured concurrency. What is structured concurrency? In layman&rsquo;s terms, it is the ability to properly implement multiple coroutines for monitoring and management. In practice, we may need to create multiple coroutines to accomplish different tasks. In order to manage these unrelated coroutines, Kotlin introduced the coroutine scope, through a certain coroutine scope created by the coroutine will be managed by it, in the conditions are met, the execution of each coroutine to cancel the work or to end their own.</p><p>To make it easier for us to get started straight away, <code>MainScope</code> and <code>GlobalScope</code> are officially provided for us to use. As the name suggests, they have different application scenarios, the former is more suitable for UI-related classes, while the latter is suitable for classes that need to survive throughout the application lifecycle. Of course, for Android developers, we actually have a better option - using the Kotlin extension for <code>ViewModel</code>, which not only has all the coroutine scoping functionality out of the box, but also implements auto-cancellation in the <code>onCleared</code> method.</p><h3 id=creating-a-coroutine class="relative group">Creating a Coroutine <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#creating-a-coroutine aria-label=Anchor>#</a></span></h3><p>With the scope of the coroutine in place, let&rsquo;s create the simplest possible coroutine.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>viewModelScope</span><span class=p>.</span><span class=n>launch</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//Here is the code for the coroutine.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>delay</span><span class=p>(</span><span class=m>2000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nc>System</span><span class=p>.</span><span class=k>out</span><span class=p>.</span><span class=n>println</span><span class=p>(</span><span class=s2>&#34;Hello World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>launch</code> creates and starts a concatenation, and two seconds after the concatenation is started, Hello World is printed on the control lift, and then the concatenation is terminated (the coroutine has a full life cycle). The work done by this coroutine is limited, we can use threads to accomplish the same function</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>thread</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nc>Thread</span><span class=p>.</span><span class=n>sleep</span><span class=p>(</span><span class=m>2000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nc>System</span><span class=p>.</span><span class=k>out</span><span class=p>.</span><span class=n>println</span><span class=p>(</span><span class=s2>&#34;Hello World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></div><p>As we can see, excluding the constructor, the only difference between the two pieces of code is the delay functions - <code>delay</code> and <code>Thread.sleep</code>. Functionally they both delay the execution of the code behind them, but the effect is different in that the former doesn&rsquo;t block the thread. This code is actually executed in the main thread, but it doesn&rsquo;t affect the UI drawing, whereas if the latter is executed in the main thread, the application will be unresponsive for two seconds.Kotlin calls this kind of function, which doesn&rsquo;t block the execution of the current thread, a suspend function, which can be used to disconnect from the current thread at the start of the suspension and allow the thread to idle and complete other operations. When the conditions are met, the pending function is restored at the starting point, and then the code is executed.</p><p>There&rsquo;s still a small problem that hasn&rsquo;t been solved. In my last post, I said that a pending function can only be executed in a pending function, and since <code>delay</code> is a pending function, then by inverse, our block of code should also be a pending function, and this pending function is the so-called coroutine body.</p><h3 id=getting-a-coroutine-to-work-across-threads class="relative group">Getting a coroutine to work across threads <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#getting-a-coroutine-to-work-across-threads aria-label=Anchor>#</a></span></h3><p>If you see the code above and then turn around and write a network request inside the body of the coroutine, you will find that your application crashes, what is going on? Because although the coroutine will not block the main thread, the main thread is not allowed to make network requests. If at this point you rush to the conclusion that coroutines are useless, then you are shallow. Let&rsquo;s change the above code a little so that it runs in a sub-thread.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>viewModelScope</span><span class=p>.</span><span class=n>launch</span> <span class=p>(</span><span class=nc>Dispatchers</span><span class=p>.</span><span class=n>IO</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=c1>//Here is the code for the coroutine.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>delay</span><span class=p>(</span><span class=m>2000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nc>System</span><span class=p>.</span><span class=k>out</span><span class=p>.</span><span class=n>println</span><span class=p>(</span><span class=s2>&#34;Hello World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Good, now the network request inside the body of the concatenation can be executed smoothly, but soon some readers will find a new problem - how can I pass the result of the network request back to the main thread, can&rsquo;t I still get a <code>Handler</code>, what&rsquo;s the difference between that and using the thread directly, hot chicken coroutine. Hey, don&rsquo;t worry, this coroutine actually takes care of that for the guest. Let&rsquo;s revamp the code again:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>viewModelScope</span><span class=p>.</span><span class=n>launch</span> <span class=p>(</span><span class=nc>Dispatchers</span><span class=p>.</span><span class=n>IO</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=c1>//Here is the coroutine code la la la la la la, here is the code executed in the sub-thread Oh!
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//Let&#39;s pretend this is a web request.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>delay</span><span class=p>(</span><span class=m>2000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>withContext</span><span class=p>(</span><span class=nc>Dispatchers</span><span class=p>.</span><span class=n>Main</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//Oh, I can&#39;t believe this is running in the main thread.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nc>System</span><span class=p>.</span><span class=k>out</span><span class=p>.</span><span class=n>println</span><span class=p>(</span><span class=s2>&#34;Hello World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Great, we can happily use coroutines to handle network requests, so how did all this magic happen, stop and let&rsquo;s revisit the code above.</p><p>First of all, compared to the code at the very beginning, we have two more objects and one more method call in our code. First let&rsquo;s look at those two objects, which we can easily guess from the names are the scheduling threads.
Kotlin provides four common implementations</p><ul><li><p><code>Default</code>, which is the default scheduler used by standard coroutine builders, works with a shared thread pool, and is suitable for computational tasks;</p></li><li><p><code>Main</code>, which is the scheduler that represents the UI thread, usually there is only one thread, using this scheduler it is possible to manipulate the UI directly in the coroutine; <code>Unconfined</code>, which is the default scheduler used by standard coroutine builders, working with a shared pool of threads, for computationally oriented tasks.</p></li><li><p><code>Unconfined</code>, which is not thread-scoped, and executes the initial code in whichever thread it is called in until it encounters a hung function, after which it resumes using the scheduler specified by the hung function, and this process can continue forever.</p></li><li><p><code>IO</code>, is used to carry blocking IO operations, such as file reads and writes, network connections, etc., is our more commonly used scheduler.</p></li></ul><p>So those two scheduler objects are the magic that allows the coroutines to switch working environments. There&rsquo;s another method call that comes next that isn&rsquo;t explained. What <code>withContext</code> does is switch the current coroutine scheduler to the specified scheduler, and with that scheduler proceed to execute the code in the building block. It is also a pending function. When we think of a pending function, we think of it as being resumable. So when the execution of the block of code in the pending function is complete, it will automatically revert to the original scheduler and continue to the next execution.</p><h3 id=serializing-two-asynchronous-operations-with-a-coroutine class="relative group">Serializing two asynchronous operations with a coroutine <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#serializing-two-asynchronous-operations-with-a-coroutine aria-label=Anchor>#</a></span></h3><p>In project development, there is another common application scenario where the client needs to request some configuration information first, and then use the configuration information to request the real content information. This process is described as serial, but the code is written in a fragmented way, you need to process the first network request callback and initiate a second request, and then in the second callback to get the real need to show the data, maybe this process will also be added to a store, or trigger another request for work, then finished, the code can not be seen. In the past, this situation would usually use RxJava, but RxJava code readability is still almost meaningless. So what can a Kotlin coroutine look like?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>viewModelScope</span><span class=p>.</span><span class=n>launch</span><span class=p>(</span><span class=nc>Dispatchers</span><span class=p>.</span><span class=n>IO</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>retrofit</span><span class=p>=</span><span class=nc>Retrofit</span><span class=p>.</span><span class=n>Builder</span><span class=p>().</span><span class=n>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>apiUser</span><span class=p>=</span><span class=n>retrofit</span><span class=p>.</span><span class=n>create</span><span class=p>(</span><span class=n>APIUser</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>user</span><span class=p>=</span><span class=n>api</span><span class=p>.</span><span class=n>current</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>detail</span><span class=p>=</span><span class=n>api</span><span class=p>.</span><span class=n>userDetail</span><span class=p>(</span><span class=n>user</span><span class=p>.</span><span class=n>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>withContext</span><span class=p>(</span><span class=nc>Dispatchers</span><span class=p>.</span><span class=n>Main</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>userLiveData</span><span class=p>.</span><span class=k>value</span><span class=p>=</span><span class=n>detail</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></div><p>It&rsquo;s exactly the same as if we were writing normal synchronized code, there are no callbacks or other costs, and the process can even be added all the time. In fact, I think this is the real power of coroutines.</p><h3 id=getting-multiple-coroutines-to-work-together class="relative group">Getting multiple coroutines to work together <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#getting-multiple-coroutines-to-work-together aria-label=Anchor>#</a></span></h3><p>Let&rsquo;s continue to complicate the usage scenario - I&rsquo;m working on a notes app for multi-end use, and now the user opens one of the pre-existing notes, and in order to allow the user to quickly navigate to the information about the last operation, on one hand I need to read the result of the last operation from the file, and on the other hand I need to pull the result of the remote operation, and then make a decision about the The two results are merged to determine the final display data. Considering that these two operations are actually parallel, the idea we had above of having the coroutines connected in series no longer applies, because the operations inside the coroutines are serial. Since one coroutine can&rsquo;t solve it, can we add another one? It looks like we can, but how do we get the results of the coroutine&rsquo;s operations? Looking at the API, I found another coroutine builder, <code>async</code>. It returns a coroutine object and then gets the result of the coroutine&rsquo;s computation via the <code>await</code> method. Here&rsquo;s the idea, let&rsquo;s do it now</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl> <span class=k>val</span> <span class=py>fileResult</span><span class=p>=</span><span class=n>viewModelScope</span><span class=p>.</span><span class=n>async</span><span class=p>(</span><span class=nc>Dispatchers</span><span class=p>.</span><span class=n>IO</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=c1>//Let&#39;s pretend it&#39;s code to read a file.
</span></span></span><span class=line><span class=cl><span class=c1></span>             <span class=m>1</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>val</span> <span class=py>networkResult</span><span class=p>=</span><span class=n>viewModelScope</span><span class=p>.</span><span class=n>async</span><span class=p>(</span><span class=nc>Dispatchers</span><span class=p>.</span><span class=n>IO</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=c1>//It&#39;s also code that pretends to be a web request
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=m>2</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>val</span> <span class=py>fResult</span><span class=p>=</span><span class=n>fileResult</span><span class=p>.</span><span class=n>await</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>rResult</span><span class=p>=</span><span class=n>networkResult</span><span class=p>.</span><span class=n>await</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>result</span><span class=p>=</span><span class=k>if</span><span class=p>(</span><span class=n>fResult</span><span class=p>&gt;</span><span class=n>rResult</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=n>fResult</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>networkResult</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Then you&rsquo;ll see that the error is reported, <code>await</code> is the pending function. It seems that two coroutines won&rsquo;t do the job, it takes three, so let&rsquo;s create a third one.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl> <span class=c1>//The first two coroutines remain unchanged
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=n>viewModelScope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=k>val</span> <span class=py>fResult</span><span class=p>=</span><span class=n>fileResult</span><span class=p>.</span><span class=n>await</span><span class=p>()</span>
</span></span><span class=line><span class=cl>     <span class=k>val</span> <span class=py>rResult</span><span class=p>=</span><span class=n>networkResult</span><span class=p>.</span><span class=n>await</span><span class=p>()</span>
</span></span><span class=line><span class=cl>     <span class=k>val</span> <span class=py>result</span><span class=p>=</span><span class=k>if</span><span class=p>(</span><span class=n>fResult</span><span class=p>&gt;</span><span class=n>rResult</span><span class=p>){</span>
</span></span><span class=line><span class=cl>         <span class=n>fResult</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=n>networkResult</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This is the basic communication between the coroutines to write it, from this basis, and even can be derived from a more complex version, but all changes are not the same, can refer to this idea to complete.</p><h3 id=cancellation-of-a-coroutine class="relative group">Cancellation of a Coroutine <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#cancellation-of-a-coroutine aria-label=Anchor>#</a></span></h3><p>As mentioned before, a coroutine has a complete life cycle similar to that of a thread, including creation, activation, completion (canceling), and completion (canceled). A coroutine has its own cancel API, <code>cancel</code>, which can be used. All we need to do is to save the coroutine object returned by the coroutine&rsquo;s creator. Of course it&rsquo;s more common to cancel using a coroutine scope as mentioned at the beginning of the article. This action will cancel all the coroutines.</p><h3 id=summary class="relative group">Summary <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#summary aria-label=Anchor>#</a></span></h3><p>This article from the beginning of the creation of concurrent programs, about how to write asynchronous code with concurrent programs, how to make multiple concurrent programs work together, although covering a large part of the use of scenarios, but there are still omissions. Due to space constraints, the missing parts will be continued in the next blog post, I hope you continue to pay attention.</p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=flex><img class="!mb-0 !mt-0 me-4 h-24 w-24 rounded-full" width=96 height=96 alt="Deep thinking" src=/images/logo_hu9224ab2ed987e0d8e6ad569f112ae59a_19203_192x192_fill_box_center_3.png loading=lazy><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Deep thinking</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=mailto:honguilee@163.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://github.com/hongui target=_blank aria-label=Github rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/en/post/A%20introduction%20to%20Kotlin%20coroutine-those%20unclear%20relationships.html><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">A introduction to Kotlin coroutine-those unclear relationships</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2021-03-26 18:50:29 +0800 +0800">26 March 2021</time>
</span></span></a></span><span><a class="group flex text-right" href=/en/post/A%20introduction%20to%20Kotlin%20cotoutine-from%20zero%20to%20multiple.html><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">A introduction to Kotlin cotoutine-from zero to multiple</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2021-03-30 19:10:30 +0800 +0800">30 March 2021</time>
</span></span><span class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&rarr;</span><span class="ltr:hidden rtl:inline">&larr;</span></span></a></span></div></div></footer></article><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2023
Deep thinking</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://github.com/jpanther/congo target=_blank rel="noopener noreferrer">Congo</a></p></div><div class="flex flex-row items-center"></div></div></footer><div id=search-wrapper class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://bravebuffalo.cc/en/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom px-1 icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>