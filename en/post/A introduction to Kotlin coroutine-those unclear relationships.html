<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="rgb(255,255,255)"><title>A introduction to Kotlin coroutine-those unclear relationships &#183; Deep thinking</title>
<meta name=title content="A introduction to Kotlin coroutine-those unclear relationships &#183; Deep thinking"><script type=text/javascript src=/js/appearance.min.022d0ebc3b46a335eb1c7ef79b7f2de143d7cd5156d433638592ef1ce5f8554e.js integrity="sha256-Ai0OvDtGozXrHH73m38t4UPXzVFW1DNjhZLvHOX4VU4="></script><link type=text/css rel=stylesheet href=/css/main.bundle.min.2dd44849efa9d0ef68e8cdede2901f86dec79026811f5cf6b25aa2b8cd8ee63e.css integrity="sha256-LdRISe+p0O9o6M3t4pAfht7HkCaBH1z2slqiuM2O5j4="><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.f29ffdffd9ab4cc95250c3c7196b2d5dae8ee6ef0a4139451073f90183ae7e31.js integrity="sha256-8p/9/9mrTMlSUMPHGWstXa6O5u8KQTlFEHP5AYOufjE=" data-copy=Copy data-copied=Copied></script><meta name=description content="
      A introduction to Kotlin coroutine-those unclear relationships
    "><link rel=canonical href=https://bravebuffalo.cc/en/post/A%20introduction%20to%20Kotlin%20coroutine-those%20unclear%20relationships.html><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="A introduction to Kotlin coroutine-those unclear relationships"><meta property="og:description" content="A introduction to Kotlin coroutine-those unclear relationships"><meta property="og:type" content="article"><meta property="og:url" content="https://bravebuffalo.cc/en/post/A%20introduction%20to%20Kotlin%20coroutine-those%20unclear%20relationships.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-03-26T18:50:29+08:00"><meta property="article:modified_time" content="2021-03-26T18:50:29+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="A introduction to Kotlin coroutine-those unclear relationships"><meta name=twitter:description content="A introduction to Kotlin coroutine-those unclear relationships"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"A introduction to Kotlin coroutine-those unclear relationships","headline":"A introduction to Kotlin coroutine-those unclear relationships","description":"A introduction to Kotlin coroutine-those unclear relationships","abstract":"Kotlin\u0026rsquo;s coroutines have been increasingly sought after by Android developers since its introduction. On the other hand, due to its huge API, it has also shut out a considerable number of developers. This article tries to start from a few important concepts of coroutines, in the complex API to restore its original face, to bring readers into the Kotlin coroutine world with a new perspective.","inLanguage":"en","url":"https:\/\/bravebuffalo.cc\/en\/post\/A%20introduction%20to%20Kotlin%20coroutine-those%20unclear%20relationships.html","author":{"@type":"Person","name":"Deep thinking"},"copyrightYear":"2021","dateCreated":"2021-03-26T18:50:29\u002b08:00","datePublished":"2021-03-26T18:50:29\u002b08:00","dateModified":"2021-03-26T18:50:29\u002b08:00","keywords":["Android","Kotlin","Coroutine"],"mainEntityOfPage":"true","wordCount":"1758"}</script><meta name=author content="Deep thinking"><link href=mailto:honguilee@163.com rel=me><link href=https://github.com/hongui rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold pe-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral print:hidden sm:py-10"><nav class="flex items-start justify-between sm:items-center"><div class="flex flex-row items-center"><a href=/en/ class=mr-2><img src=/images/logo.png width=500 height=500 class="max-h-[10rem] max-w-[10rem] object-scale-down object-left" alt="Deep thinking">
</a><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/en/>Deep thinking</a></div><ul class="flex flex-col list-none text-end sm:flex-row"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/en/posts/ title=Posts><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Blog</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/en/categories/ title=Categories><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Categories</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/en/tags/ title=Tags><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Tags</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/en/about.html title="About me"><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">About</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><button id=search-button-1 title="Search (/)">
<span class="transition-colors group-dark:hover:text-primary-400 group-hover:text-primary-600"><span class="relative inline-block align-text-bottom px-1 icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></button></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><div class="relative group"><button class="flex items-center justify-end w-full transition-colors group-dark:hover:text-primary-400 group-hover:text-primary-600">
<span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill="currentcolor" d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286H4.545zm1.634-.736L5.5 3.956h-.049l-.679 2.022H6.18z"/><path fill="currentcolor" d="M0 2a2 2 0 012-2h7a2 2 0 012 2v3h3a2 2 0 012 2v7a2 2 0 01-2 2H7a2 2 0 01-2-2v-3H2A2 2 0 010 9V2zm2-1A1 1 0 001 2v7a1 1 0 001 1h7a1 1 0 001-1V2A1 1 0 009 1H2zm7.138 9.995c.193.301.402.583.63.846-.748.575-1.673 1.001-2.768 1.292.178.217.451.635.555.867 1.125-.359 2.08-.844 2.886-1.494.777.665 1.739 1.165 2.93 1.472.133-.254.414-.673.629-.89-1.125-.253-2.057-.694-2.82-1.284.681-.747 1.222-1.651 1.621-2.757H14V8h-3v1.047h.765c-.318.844-.74 1.546-1.272 2.13a6.066 6.066.0 01-.415-.492 1.988 1.988.0 01-.94.31z"/></svg></span><span class=text-sm>EN</span><span class=text-[0.6rem]><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M233.4 406.6c12.5 12.5 32.8 12.5 45.3.0l192-192c12.5-12.5 12.5-32.8.0-45.3s-32.8-12.5-45.3.0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3.0s-12.5 32.8.0 45.3l192 192z"/></svg></span></span></button><div class="invisible w-full h-2 bg-transparent group-hover:visible"></div><div class="top-8 invisible absolute ltr:right-0 rtl:left-0 z-50 flex flex-col whitespace-nowrap rounded border border-neutral-300 bg-neutral text-start text-base shadow group-hover:visible dark:border-neutral-600 dark:bg-neutral-800"><div class="flex flex-grow"><a href=/en/post/A%20introduction%20to%20Kotlin%20coroutine-those%20unclear%20relationships.html class="flex items-center justify-between w-full px-2 py-1 bg-primary-100 dark:bg-primary-900">English<span class="w-6 ms-2 text-primary-600 dark:text-primary-400"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M438.6 105.4c12.5 12.5 12.5 32.7.0 45.2l-256 256c-12.5 12.5-32.7 12.5-45.2.0L9.372 278.6c-12.496-12.5-12.496-32.7.0-45.2 12.498-12.5 32.758-12.5 45.258.0L159.1 338.7 393.4 105.4c12.5-12.52 32.7-12.52 45.2.0h0z"/></svg></span></span></a></div><div class="flex flex-grow"><a href=/post/Kotlin%E5%8D%8F%E7%A8%8B-%E9%82%A3%E4%BA%9B%E7%90%86%E4%B8%8D%E6%B8%85%E4%B9%B1%E4%B8%8D%E6%98%8E%E7%9A%84%E5%85%B3%E7%B3%BB.html class="w-full py-1 pe-10 ps-2 decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2">简体中文</a></div></div></div></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">A introduction to Kotlin coroutine-those unclear relationships</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2021-03-26 18:50:29 +0800 +0800">26 March 2021</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">9 mins</span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-prose grow"><blockquote><p>Kotlin&rsquo;s coroutines have been increasingly sought after by Android developers since its introduction. On the other hand, due to its huge API, it has also shut out a considerable number of developers. This article tries to start from a few important concepts of coroutines, in the complex API to restore its original face, to bring readers into the Kotlin coroutine world with a new perspective.</p></blockquote><h3 id=what-is-coroutine class="relative group">What is coroutine <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#what-is-coroutine aria-label=Anchor>#</a></span></h3><p>In many articles about coroutines, describing them is usually done with this one sentence description - coroutines are more lightweight than threads and are cancelable. There is nothing wrong with this statement, both are advantages of coroutines, but they are not characteristics, and it doesn&rsquo;t explain what coroutines are. So what are the characteristics of a coroutine, I think we can start with an analogy with threads, <em><strong>The best way to explain a concept is by analogy.</strong></em> Instead of using a scientifically rigorous description, I&rsquo;d like to give thread my own definition - a thread is an execution unit that is available for CPU scheduling, it has its own execution block and can execute logic independently. I&rsquo;ve deliberately listed three key characteristics of a thread:</p><ul><li>Threads are scheduled by the CPU</li><li>Threads have their own blocks of code</li><li>Code blocks are required in order to schedule execution</li></ul><p>This is my intuition about threads and that these characteristics are able to be reflected in the code. For example, <code>Thread</code> in Java is a thread and at the same time an entity object that can be recognized and used through the API. And what makes it special are the three things I listed above, all of which are thread-specific. I&rsquo;ll try to give my own definition of a coroutine along the same lines - a coroutine is an execution unit that is scheduled for execution by a thread, and it also has its own execution block that can execute logic independently or collaboratively. In fact, Kotlin&rsquo;s coroutines also have their own corresponding entities and operation APIs, and even threads are also very similar (such as the life cycle), but because Kotlin&rsquo;s encapsulation of coroutines is too thorough, many APIs are not exposed, so my understanding of coroutines has been in the state of blind men feeling the elephant. In addition, in fact, there are a variety of ways to implement the coroutine, the following my views only for Kotlin&rsquo;s implementation of the coroutine, may not be consistent with the implementation of other languages.</p><p>***A coroutine object in Kotlin is essentially an executable block of code,***and the code that is executed is passed in to create the coroutine. In addition to this, it has another great feature - a coroutine is not thread-bound. It can disconnect from the current thread at some point and then attach to another thread at another time. In other words, it&rsquo;s like a ping pong ball, and threads are like paddles that it can repeatedly hop across between. So, combining these two characteristics, the official definition of a coroutine is <em><strong>a suspend computational entity</strong></em>. I don&rsquo;t think this definition is precise, it only reflects the concept of hanging, not the concept of recovery. I&rsquo;ll give it a definition of my own - <em><strong>a computational entity that can be scheduled</strong></em>.</p><h3 id=a-few-key-concepts-in-coroutine class="relative group">A few key concepts in coroutine <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#a-few-key-concepts-in-coroutine aria-label=Anchor>#</a></span></h3><p>Understanding what a coroutine is isn&rsquo;t enough, because there&rsquo;s a lot more to Kotlin&rsquo;s coroutine, and there are a few key concepts to understand.</p><h4 id=suspend-function class="relative group">Suspend function <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#suspend-function aria-label=Anchor>#</a></span></h4><p>The mention of Kotlin&rsquo;s coroutines necessitates the mention of the suspend function, which is one of the most important concepts of Kotlin&rsquo;s coroutine implementation. Simply put, <em><strong>a suspend function is an asynchronous implementation solution that has the properties of pending and resuming on the premise that it is a normal function.</strong></em> It is a solution to time-consuming computation and result passing. So how does it compare to our common callback based scheme. In the callback-based scheme, the computation process and the result have no relationship, the result needs to be passed through another object, after the completion of the calculation by the computation process manually passed, and this process is possible to be repeatedly nested, which leads to, some of the code that should be serialized, was cut into several parts, scattered into different blocks of code. For example, the following code reads and writes a file</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl> <span class=c1>// asynchronously read into `buf`, and when done run the lambda
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=n>inChannel</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=c1>// this lambda is executed when the reading completes
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=n>bytesRead</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>     <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>     <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>     <span class=n>process</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>bytesRead</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>     <span class=c1>// asynchronously write from `buf`, and when done run the lambda
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>outChannel</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// this lambda is executed when the writing completes
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>        <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>        <span class=n>outFile</span><span class=p>.</span><span class=n>close</span><span class=p>()</span>          
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>What can the same logic be written with <code>read</code> and <code>write</code> implemented as suspend functions?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl> <span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=c1>// suspend while asynchronously reading
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=k>val</span> <span class=py>bytesRead</span> <span class=p>=</span> <span class=n>inChannel</span><span class=p>.</span><span class=n>aRead</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>     <span class=c1>// we only get to this line when reading completes
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>     <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>     <span class=n>process</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>bytesRead</span><span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=c1>// suspend while asynchronously writing   
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=n>outChannel</span><span class=p>.</span><span class=n>aWrite</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// we only get to this line when writing completes  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=n>outFile</span><span class=p>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This is an official example given by Kotlin, and you can see that the implementation of the suspend function is very intuitive, is consistent with the thought process, and also reduces a lot of nesting.</p><p>To better explain the suspend function, I also need to introduce a new concept - the suspend point.
A suspend point is a demarcation point that represents the point after which the execution process may move to execute elsewhere and then, at some point, resume from that point and continue down the line. The current thread is not blocked during this process. So ***the suspend function actually implements an asynchronous non-blocking communication model. ***</p><p>In a nutshell, a suspend function is a function that does not block the current thread and returns the result of an asynchronous computation.</p><h4 id=concurrent-creators class="relative group">Concurrent Creators <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#concurrent-creators aria-label=Anchor>#</a></span></h4><p>The previously mentioned pending function is good, but there is a limitation. Ordinary methods cannot call pending functions, they can only be called through a pending function. So the question arises whether the chicken or the egg comes first. The solution to this problem is the coroutine creator. <code>launch</code>, <code>future</code>, <code>sequence</code> are all coroutine creators. As the name suggests, coroutines are used to create coroutine objects and are otherwise indistinguishable from normal functions. They are the gateway to the world of coroutines and hung functions. Inside this gateway, we can use pending functions to our heart&rsquo;s content, simplifying our computations. Of course, none of this is fixed, and these functions have several configuration parameters, the most important of which is <code>CoroutineContext</code>.</p><h4 id=coroutinecontext class="relative group"><code>CoroutineContext</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#coroutinecontext aria-label=Anchor>#</a></span></h4><p>The role of <code>CoroutineContext</code> is to provide various configuration information for the coroutine, <em><strong>essentially a container (Set)</strong></em> that holds non-duplicated elements that can be fetched based on a Key (e.g., a scheduler), called an Element. Here, I couldn&rsquo;t resist putting up its interface definition because it&rsquo;s just so beautiful.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl> <span class=k>interface</span> <span class=nc>CoroutineContext</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=k>operator</span> <span class=k>fun</span> <span class=p>&lt;</span><span class=nc>E</span> <span class=p>:</span> <span class=nc>Element</span><span class=p>&gt;</span> <span class=nf>get</span><span class=p>(</span><span class=n>key</span><span class=p>:</span> <span class=n>Key</span><span class=p>&lt;</span><span class=n>E</span><span class=p>&gt;):</span> <span class=n>E</span><span class=p>?</span>
</span></span><span class=line><span class=cl>     <span class=k>fun</span> <span class=p>&lt;</span><span class=nc>R</span><span class=p>&gt;</span> <span class=nf>fold</span><span class=p>(</span><span class=n>initial</span><span class=p>:</span> <span class=n>R</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=p>(</span><span class=n>R</span><span class=p>,</span> <span class=n>Element</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>R</span><span class=p>):</span> <span class=n>R</span>
</span></span><span class=line><span class=cl>     <span class=k>operator</span> <span class=k>fun</span> <span class=nf>plus</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>CoroutineContext</span><span class=p>):</span> <span class=n>CoroutineContext</span>
</span></span><span class=line><span class=cl>     <span class=k>fun</span> <span class=nf>minusKey</span><span class=p>(</span><span class=n>key</span><span class=p>:</span> <span class=n>Key</span><span class=p>&lt;*&gt;):</span> <span class=n>CoroutineContext</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>     <span class=k>interface</span> <span class=nc>Element</span> <span class=p>:</span> <span class=n>CoroutineContext</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>val</span> <span class=py>key</span><span class=p>:</span> <span class=n>Key</span><span class=p>&lt;*&gt;</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>interface</span> <span class=nc>Key</span><span class=p>&lt;</span><span class=n>E</span> <span class=p>:</span> <span class=n>Element</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>These are the definitions of <code>CoroutineContext</code> in Kotlin, and each of these APIs has its own clever use, which is breathtaking!</p><ul><li><p>The purpose of <code>get</code> is to get the corresponding object based on the Key, and the quirky thing about this method is the query parameter. This method is used to determine if <code>CoroutineContext</code> has a certain configuration object before performing an operation, thus enabling a kind of privilege authentication.</p></li><li><p><code>fold</code> is actually an iterative algorithm that checks for all elements.</p></li><li><p><code>plus</code> which is interesting in that it allows two objects to be merged and uses the right object to overwrite the left object when the <code>key</code> is the same. This is definitely the most flexible API in our use of coroutines. We can use + to replace the original scheduler with our given scheduler, and it looks so natural.</p></li><li><p><code>minusKey</code> returns a <code>context</code> that doesn&rsquo;t contain the specified <code>key</code>, which is equivalent to an inverse operation, which can be very useful in certain contexts.</p></li></ul><p>I think this should be considered the ultimate embodiment of abstraction, this interface with a simple API abstraction of the four operations of add, delete, change and check, and retain a strong scalability. At the very beginning of my contact with coroutines, I often had deep doubts about the complex working mechanism and simple parameter configuration of coroutines, until I saw this definition, I realized how powerful it really is, not only can it use the system&rsquo;s default working configuration to complete the work, but also allows the user to implement their own <code>CoroutineContext</code> to replace the default configuration at any time, to complete their own customized tasks.</p><h4 id=continuation class="relative group"><code>Continuation</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#continuation aria-label=Anchor>#</a></span></h4><p><code>Continuation</code> is not a Kotlin-specific concept; it is explained on the wiki as an abstract representation of control state. In Kotlin, it is an abstraction of the state of a coroutine at the starting point of a hang, which may not be well understood, and we can concretize this concept with a specific API.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>interface</span> <span class=nc>Continuation</span><span class=p>&lt;</span><span class=k>in</span> <span class=n>T</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>val</span> <span class=py>context</span><span class=p>:</span> <span class=n>CoroutineContext</span>
</span></span><span class=line><span class=cl>   <span class=k>fun</span> <span class=nf>resumeWith</span><span class=p>(</span><span class=n>result</span><span class=p>:</span> <span class=n>Result</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>It has a key function, resumeWith, which indicates that the state object is resumed from its original position by this state object at some point after the hung state. This is the key to the implementation of the resume function. The state of control here is represented by the parameters, success or failure, so it has two more extension methods:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>fun</span> <span class=p>&lt;</span><span class=nc>T</span><span class=p>&gt;</span> <span class=nf>Continuation</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;.</span><span class=n>resume</span><span class=p>(</span><span class=k>value</span><span class=p>:</span> <span class=n>T</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=p>&lt;</span><span class=nc>T</span><span class=p>&gt;</span> <span class=nf>Continuation</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;.</span><span class=n>resumeWithException</span><span class=p>(</span><span class=n>exception</span><span class=p>:</span> <span class=n>Throwable</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=summary class="relative group">Summary <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#summary aria-label=Anchor>#</a></span></h3><p>A coroutine is a schedulable computational entity that can be created by a coroutine creator. A pending function can be used in a coroutine&rsquo;s code block, which can hang when necessary and then resume when conditions are met, completing the serialized programming of asynchronous code.</p><p>The above is to understand the key concepts of coroutines, in the actual use of coroutines in the process may not be used a lot, but it will help us to understand the process of its operation, but also to write a standard coroutine code is the key to the Kotlin coroutines do not have a lot of black magic, just for the application of a variety of different scenarios, there is a huge API, this article is a general explanation of these APIs, and later on, will be for a variety of scenarios in detail. This post is a general explanation of these APIs, later will be for a variety of scenarios and then combed in detail, I hope you enjoy.</p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=flex><img class="!mb-0 !mt-0 me-4 h-24 w-24 rounded-full" width=96 height=96 alt="Deep thinking" src=/images/logo_hu9224ab2ed987e0d8e6ad569f112ae59a_19203_192x192_fill_box_center_3.png loading=lazy><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Deep thinking</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=mailto:honguilee@163.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://github.com/hongui target=_blank aria-label=Github rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span></span><span><a class="group flex text-right" href=/en/post/A%20introduction%20to%20Kotlin%20coroutine-from%20theory%20to%20practice.html><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">A introduction to Kotlin coroutine-from theory to practice</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2021-03-27 19:02:30 +0800 +0800">27 March 2021</time>
</span></span><span class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&rarr;</span><span class="ltr:hidden rtl:inline">&larr;</span></span></a></span></div></div></footer></article><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2023
Deep thinking</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://github.com/jpanther/congo target=_blank rel="noopener noreferrer">Congo</a></p></div><div class="flex flex-row items-center"></div></div></footer><div id=search-wrapper class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://bravebuffalo.cc/en/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom px-1 icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>