<!doctype html><html lang=zh-CN dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#FFFFFF"><title>Android音视频应用性能测试指南 &#183; 低头沉思</title>
<meta name=title content="Android音视频应用性能测试指南 &#183; 低头沉思"><script type=text/javascript src=/js/appearance.min.8a082f81b27f3cb2ee528df0b0bdc39787034cf2cc34d4669fbc9977c929023c.js integrity="sha256-iggvgbJ/PLLuUo3wsL3Dl4cDTPLMNNRmn7yZd8kpAjw="></script><link type=text/css rel=stylesheet href=/css/main.bundle.min.b0785c8131a75f72b211435af86269eb2d4b81dda03a8f2cf5ccb1c967747167.css integrity="sha256-sHhcgTGnX3KyEUNa+GJp6y1Lgd2gOo8s9cyxyWd0cWc="><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.af5d9722112bedac95702865c340bcd6286c4e9b2c15ce26b531ea1fba974cb8.js integrity="sha256-r12XIhEr7ayVcChlw0C81ihsTpssFc4mtTHqH7qXTLg=" data-copy data-copied></script><meta name=description content="
      JNI开发概念
    "><link rel=canonical href=https://deep-thinking.top/posts/a-guide-for-performance-testing-of-android-real-time-applications/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://deep-thinking.top/posts/a-guide-for-performance-testing-of-android-real-time-applications/"><meta property="og:site_name" content="低头沉思"><meta property="og:title" content="Android音视频应用性能测试指南"><meta property="og:description" content="JNI开发概念"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-24T13:55:45+08:00"><meta property="article:modified_time" content="2024-11-24T13:55:45+08:00"><meta property="article:tag" content="Android"><meta property="article:tag" content="性能测试"><meta property="article:tag" content="ADB"><meta property="article:tag" content="Python"><meta property="article:tag" content="音视频"><meta name=twitter:card content="summary"><meta name=twitter:title content="Android音视频应用性能测试指南"><meta name=twitter:description content="JNI开发概念"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Android音视频应用性能测试指南","headline":"Android音视频应用性能测试指南","description":"JNI开发概念","abstract":"\u003cp\u003e随着Android平台的发展，Android应用规模越来越大，类型也越来越多，为了保证应用的质量，性能测试的作用愈加凸显。在进行性能测试的过程中，我们会发现不同类型的应用关注点不尽一致，因此需要针对应用类型制定合适的指标。同时性能测试工具也在不断进化，很多性能测试工具在2024年已经过时。所以本篇将结合项目实际，聊一聊音视频应用的性能测试指标，并给出一些性能测试的工具推荐。\u003c\/p\u003e\n\u003ch2 id=\u0022性能测试指标\u0022 class=\u0022relative group\u0022\u003e性能测试指标 \u003cspan class=\u0022absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100\u0022\u003e\u003ca class=\u0022group-hover:text-primary-300 dark:group-hover:text-neutral-700\u0022 style=\u0022text-decoration-line: none !important;\u0022 href=\u0022#%e6%80%a7%e8%83%bd%e6%b5%8b%e8%af%95%e6%8c%87%e6%a0%87\u0022 aria-label=\u0022\u0022\u003e#\u003c\/a\u003e\u003c\/span\u003e\u003c\/h2\u003e\u003cp\u003e性能测试指标选择的原则是：以核心业务为参照，着重关注用户感知明显的部分，用户感知不强的部分则可以适当忽略。音频频应用的主要业务就是音视频处理，需要处理大量的数据，处理大量数据需要占用大量CPU和GPU的时间，占用大量内存。CPU和GPU一直以高负荷的状态工作，则会导致发热量增大，增加电量消耗。所以，音视频应用的性能指标就很明朗了。\u003c\/p\u003e\n\u003col\u003e\n\u003cli\u003eCPU占用率\u003c\/li\u003e\n\u003cli\u003eGPU占用率\u003c\/li\u003e\n\u003cli\u003e内存占用率\u003c\/li\u003e\n\u003cli\u003e比特率和帧率\u003c\/li\u003e\n\u003cli\u003e温度变化\u003c\/li\u003e\n\u003cli\u003e耗电量\n有了指标，接下来的主要任务就是获取这些指标数据。获取数据的方式有很多，大体可以分为应用内获取和应用外获取。应用内获取会比较直观，但是获取这些数据的过程中会影响到应用本身，影响指标数据。所以绝大部分情况下是采用应用外获取的方式。应用外获取最重要的工具就是ADB。\u003c\/li\u003e\n\u003c\/ol\u003e\n\u003ch2 id=\u0022adb\u0022 class=\u0022relative group\u0022\u003eADB \u003cspan class=\u0022absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100\u0022\u003e\u003ca class=\u0022group-hover:text-primary-300 dark:group-hover:text-neutral-700\u0022 style=\u0022text-decoration-line: none !important;\u0022 href=\u0022#adb\u0022 aria-label=\u0022\u0022\u003e#\u003c\/a\u003e\u003c\/span\u003e\u003c\/h2\u003e\u003cp\u003eadb正如它名字蕴含的意义一样，它是PC和Android设备之间沟通的桥梁，是Android开发中极为重要的工具。我们不仅开发过程中需要用到它，性能测试更是少不了。通过它这个媒介，我们得以使用很多Android平台的工具，如本期性能测试的主角——\u003ccode\u003edumpsys\u003c\/code\u003e。\u003ccode\u003edumpsys\u003c\/code\u003e可以获取系统服务的很多信息。接下来我们将逐一介绍这些服务，并提供相应的Python脚本来解析这些服务数据，并将解析得到的数据保存在.\u003ccode\u003ecsv\u003c\/code\u003e文件中。\u003c\/p\u003e\n\u003ch2 id=\u0022准备工作\u0022 class=\u0022relative group\u0022\u003e准备工作 \u003cspan class=\u0022absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100\u0022\u003e\u003ca class=\u0022group-hover:text-primary-300 dark:group-hover:text-neutral-700\u0022 style=\u0022text-decoration-line: none !important;\u0022 href=\u0022#%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c\u0022 aria-label=\u0022\u0022\u003e#\u003c\/a\u003e\u003c\/span\u003e\u003c\/h2\u003e\u003cp\u003e通过前面的铺垫，我们明确了接下来要做的工作，但是在正式开始之前，我们先来总结一下需要做哪些准备：\u003c\/p\u003e\n\u003cul\u003e\n\u003cli\u003e测试机-运行测试应用\u003c\/li\u003e\n\u003cli\u003ePC-运行Python脚本\u003c\/li\u003e\n\u003cli\u003eADB-在PC上获取手机上的数据\u003c\/li\u003e\n\u003cli\u003ePython-解析数据\u003c\/li\u003e\n\u003c\/ul\u003e\n\u003ch3 id=\u0022连接测试机和pc\u0022 class=\u0022relative group\u0022\u003e连接测试机和PC \u003cspan class=\u0022absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100\u0022\u003e\u003ca class=\u0022group-hover:text-primary-300 dark:group-hover:text-neutral-700\u0022 style=\u0022text-decoration-line: none !important;\u0022 href=\u0022#%e8%bf%9e%e6%8e%a5%e6%b5%8b%e8%af%95%e6%9c%ba%e5%92%8cpc\u0022 aria-label=\u0022\u0022\u003e#\u003c\/a\u003e\u003c\/span\u003e\u003c\/h3\u003e\u003cp\u003e很多人会疑问，我直接数据线插在手机上，配置好adb环境变量不就完成了吗，这有啥好展开说的。其实还真有，直接数据线连接，这种方式虽然简单快速，但是对于性能测试影响很大。首先是它无法得到电量消耗的数据。其次由于在充电状态，CPU和GPU的频率可能和使用电池时的频率差别很大，导致整个测试数据不可靠，所以需要采用无线连接的方式。\n无线连接也有两种方式可以选择。一种是Android11及以上的无线调试功能，这个功能我用着不是很稳定，况且对系统有限制，所以我使用第二种方法。第二种方法则是使用ADB WI-FI这个插件，可以直接在插件市场下载安装。下图就是它的详情图。\n\n\n\n\n\n\n\u003cfigure\u003e\n    \n    \n\n\n\n\n\n\n\n\n  \n    \u003cpicture\n      class=\u0022mx-auto my-0 rounded-md\u0022\n      \n    \u003e\n      \n      \n      \n      \n        \u003csource\n          \n            srcset=\u0022\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi_hu15442713671799381545.webp 330w,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi_hu735392842479670477.webp 660w\n            \n              \n                ,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi_hu4792012550016215299.webp 822w\n              \n            \n            \n              \n                ,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi_hu4792012550016215299.webp 822w\n              \n            \u0022\n          \n          sizes=\u0022100vw\u0022\n          type=\u0022image\/webp\u0022\n        \/\u003e\n      \n      \u003cimg\n        width=\u0022822\u0022\n        height=\u00221066\u0022\n        class=\u0022mx-auto my-0 rounded-md\u0022\n        alt=\u0022adb Wi-Fi\u0022\n        loading=\u0022lazy\u0022 decoding=\u0022async\u0022\n        \n          src=\u0022\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi_hu16148909346628414716.png\u0022\n          srcset=\u0022\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi_hu9775292770984504168.png 330w,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi_hu16148909346628414716.png 660w\n          \n            ,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi.png 822w\n          \n          \n            ,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi.png 822w\n          \u0022\n          sizes=\u0022100vw\u0022\n        \n      \/\u003e\n    \u003c\/picture\u003e\n  \n\n\u003cfigcaption class=\u0022text-center\u0022\u003eADB Wi-Fi\u003c\/figcaption\u003e\n\u003c\/figure\u003e\n\n这个插件第一次使用需要先用数据线连接成功一次，点击屏幕右侧的Wi-Fi图标后页面会显示如下\n\n\n\n\n\n\n\u003cfigure\u003e\n    \n    \n\n\n\n\n\n\n\n\n  \n    \u003cpicture\n      class=\u0022mx-auto my-0 rounded-md\u0022\n      \n    \u003e\n      \n      \n      \n      \n        \u003csource\n          \n            srcset=\u0022\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi%20no%20device%20connected_hu7122000307785261281.webp 330w,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi%20no%20device%20connected_hu16676159757827291859.webp 660w\n            \n              ,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi%20no%20device%20connected_hu9795437890836047099.webp 1024w\n            \n            \n              \n                ,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi%20no%20device%20connected_hu6509426226124795222.webp 1076w\n              \n            \u0022\n          \n          sizes=\u0022100vw\u0022\n          type=\u0022image\/webp\u0022\n        \/\u003e\n      \n      \u003cimg\n        width=\u00221076\u0022\n        height=\u00221136\u0022\n        class=\u0022mx-auto my-0 rounded-md\u0022\n        alt=\u0022adb Wi-Fi no device connect\u0022\n        loading=\u0022lazy\u0022 decoding=\u0022async\u0022\n        \n          src=\u0022\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi%20no%20device%20connected_hu753898940375417646.png\u0022\n          srcset=\u0022\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi%20no%20device%20connected_hu15436819717325159104.png 330w,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi%20no%20device%20connected_hu753898940375417646.png 660w\n          \n            ,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi%20no%20device%20connected_hu5343957964770356028.png 1024w\n          \n          \n            ,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi%20no%20device%20connected.png 1076w\n          \u0022\n          sizes=\u0022100vw\u0022\n        \n      \/\u003e\n    \u003c\/picture\u003e\n  \n\n\u003cfigcaption class=\u0022text-center\u0022\u003eADB Wi-Fi no device connected\u003c\/figcaption\u003e\n\u003c\/figure\u003e\n\n它会显示两个设备，一个显示信号图标代表有线连接，一个显示Wi-Fi图标，代表无线连接。现在需要点击带有Wi-Fi图标设备右侧对应的connect按钮，开始连接。连接完成后，页面状态会变成Disconnect,显示如下\n\n\n\n\n\n\n\u003cfigure\u003e\n    \n    \n\n\n\n\n\n\n\n\n  \n    \u003cpicture\n      class=\u0022mx-auto my-0 rounded-md\u0022\n      \n    \u003e\n      \n      \n      \n      \n        \u003csource\n          \n            srcset=\u0022\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi%20connected%20a%20device_hu13108464419711832032.webp 330w,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi%20connected%20a%20device_hu11752774611748257366.webp 660w\n            \n              ,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi%20connected%20a%20device_hu10579237283434009181.webp 1024w\n            \n            \n              \n                ,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi%20connected%20a%20device_hu17396940255916960380.webp 1076w\n              \n            \u0022\n          \n          sizes=\u0022100vw\u0022\n          type=\u0022image\/webp\u0022\n        \/\u003e\n      \n      \u003cimg\n        width=\u00221076\u0022\n        height=\u00221136\u0022\n        class=\u0022mx-auto my-0 rounded-md\u0022\n        alt=\u0022adb Wi-Fi connnected a device\u0022\n        loading=\u0022lazy\u0022 decoding=\u0022async\u0022\n        \n          src=\u0022\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi%20connected%20a%20device_hu3288020292062024895.png\u0022\n          srcset=\u0022\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi%20connected%20a%20device_hu1424295582182547470.png 330w,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi%20connected%20a%20device_hu3288020292062024895.png 660w\n          \n            ,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi%20connected%20a%20device_hu2596381540298179210.png 1024w\n          \n          \n            ,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20Wi-Fi%20connected%20a%20device.png 1076w\n          \u0022\n          sizes=\u0022100vw\u0022\n        \n      \/\u003e\n    \u003c\/picture\u003e\n  \n\n\u003cfigcaption class=\u0022text-center\u0022\u003eadb Wi-Fi connnected a device\u003c\/figcaption\u003e\n\u003c\/figure\u003e\n\n这时候就代表设备连接成功了。移除数据线，再次运行\u003ccode\u003eadb devices\u003c\/code\u003e命令，会显示已经连接的设备。结果类似于下图这种\n\n\n\n\n\n\n\u003cfigure\u003e\n    \n    \n\n\n\n\n\n\n\n\n  \n    \u003cpicture\n      class=\u0022mx-auto my-0 rounded-md\u0022\n      \n    \u003e\n      \n      \n      \n      \n        \u003csource\n          \n            srcset=\u0022\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20devices%20command_hu6974142891576503149.webp 330w,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20devices%20command_hu5924656702488863954.webp 660w\n            \n              ,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20devices%20command_hu14180893446170022563.webp 1024w\n            \n            \n              \n                ,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20devices%20command_hu12761430981142511050.webp 1132w\n              \n            \u0022\n          \n          sizes=\u0022100vw\u0022\n          type=\u0022image\/webp\u0022\n        \/\u003e\n      \n      \u003cimg\n        width=\u00221132\u0022\n        height=\u0022108\u0022\n        class=\u0022mx-auto my-0 rounded-md\u0022\n        alt=\u0022adb devices command\u0022\n        loading=\u0022lazy\u0022 decoding=\u0022async\u0022\n        \n          src=\u0022\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20devices%20command_hu461431289447161146.png\u0022\n          srcset=\u0022\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20devices%20command_hu9731077936867018761.png 330w,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20devices%20command_hu461431289447161146.png 660w\n          \n            ,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20devices%20command_hu14932742278956815081.png 1024w\n          \n          \n            ,\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/adb%20devices%20command.png 1132w\n          \u0022\n          sizes=\u0022100vw\u0022\n        \n      \/\u003e\n    \u003c\/picture\u003e\n  \n\n\u003cfigcaption class=\u0022text-center\u0022\u003eadb devices command\u003c\/figcaption\u003e\n\u003c\/figure\u003e\n\n这种就代表adb准备完成了。\u003c\/p\u003e","inLanguage":"zh-CN","url":"https:\/\/deep-thinking.top\/posts\/a-guide-for-performance-testing-of-android-real-time-applications\/","author":{"@type":"Person","name":"低头沉思"},"copyrightYear":"2024","dateCreated":"2024-11-24T13:55:45\u002b08:00","datePublished":"2024-11-24T13:55:45\u002b08:00","dateModified":"2024-11-24T13:55:45\u002b08:00","keywords":["Android","性能测试","ADB","Python","音视频"],"mainEntityOfPage":"true","wordCount":"712"}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://deep-thinking.top/","name":"低头沉思","position":1},{"@type":"ListItem","item":"https://deep-thinking.top/posts/","name":"Posts","position":2},{"@type":"ListItem","item":"https://deep-thinking.top/categories/performance/","name":"Performance","position":3},{"@type":"ListItem","name":"Android音视频应用性能测试指南","position":4}]}</script><meta name=author content="低头沉思"><link href=mailto:honguilee@163.com rel=me><link href=https://github.com/hongui rel=me><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9595252324232542" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-9W0KC5D9EZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9W0KC5D9EZ")</script></head><body class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span></a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral sm:py-10 print:hidden"><nav class="flex items-start justify-between sm:items-center"><div class="flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>低头沉思</a></div><ul class="flex list-none flex-col text-end sm:flex-row"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/posts/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">文章</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/categories/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">分类</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/tags/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">标签</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/about.html title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">关于</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><button id=search-button-1 title>
<span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></button></li></ul></nav></header><div class="relative flex grow flex-col"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mb-8 mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Android音视频应用性能测试指南</h1><div class="mb-10 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2024-11-24 13:55:45 +0800 +0800"></time><span class="px-2 text-primary-500">&#183;</span><span title></span></div></div></header><section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row"><div class="min-h-0 min-w-0 max-w-prose grow"><p>随着Android平台的发展，Android应用规模越来越大，类型也越来越多，为了保证应用的质量，性能测试的作用愈加凸显。在进行性能测试的过程中，我们会发现不同类型的应用关注点不尽一致，因此需要针对应用类型制定合适的指标。同时性能测试工具也在不断进化，很多性能测试工具在2024年已经过时。所以本篇将结合项目实际，聊一聊音视频应用的性能测试指标，并给出一些性能测试的工具推荐。</p><h2 id=性能测试指标 class="relative group">性能测试指标 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%80%a7%e8%83%bd%e6%b5%8b%e8%af%95%e6%8c%87%e6%a0%87 aria-label>#</a></span></h2><p>性能测试指标选择的原则是：以核心业务为参照，着重关注用户感知明显的部分，用户感知不强的部分则可以适当忽略。音频频应用的主要业务就是音视频处理，需要处理大量的数据，处理大量数据需要占用大量CPU和GPU的时间，占用大量内存。CPU和GPU一直以高负荷的状态工作，则会导致发热量增大，增加电量消耗。所以，音视频应用的性能指标就很明朗了。</p><ol><li>CPU占用率</li><li>GPU占用率</li><li>内存占用率</li><li>比特率和帧率</li><li>温度变化</li><li>耗电量
有了指标，接下来的主要任务就是获取这些指标数据。获取数据的方式有很多，大体可以分为应用内获取和应用外获取。应用内获取会比较直观，但是获取这些数据的过程中会影响到应用本身，影响指标数据。所以绝大部分情况下是采用应用外获取的方式。应用外获取最重要的工具就是ADB。</li></ol><h2 id=adb class="relative group">ADB <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#adb aria-label>#</a></span></h2><p>adb正如它名字蕴含的意义一样，它是PC和Android设备之间沟通的桥梁，是Android开发中极为重要的工具。我们不仅开发过程中需要用到它，性能测试更是少不了。通过它这个媒介，我们得以使用很多Android平台的工具，如本期性能测试的主角——<code>dumpsys</code>。<code>dumpsys</code>可以获取系统服务的很多信息。接下来我们将逐一介绍这些服务，并提供相应的Python脚本来解析这些服务数据，并将解析得到的数据保存在.<code>csv</code>文件中。</p><h2 id=准备工作 class="relative group">准备工作 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c aria-label>#</a></span></h2><p>通过前面的铺垫，我们明确了接下来要做的工作，但是在正式开始之前，我们先来总结一下需要做哪些准备：</p><ul><li>测试机-运行测试应用</li><li>PC-运行Python脚本</li><li>ADB-在PC上获取手机上的数据</li><li>Python-解析数据</li></ul><h3 id=连接测试机和pc class="relative group">连接测试机和PC <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e8%bf%9e%e6%8e%a5%e6%b5%8b%e8%af%95%e6%9c%ba%e5%92%8cpc aria-label>#</a></span></h3><p>很多人会疑问，我直接数据线插在手机上，配置好adb环境变量不就完成了吗，这有啥好展开说的。其实还真有，直接数据线连接，这种方式虽然简单快速，但是对于性能测试影响很大。首先是它无法得到电量消耗的数据。其次由于在充电状态，CPU和GPU的频率可能和使用电池时的频率差别很大，导致整个测试数据不可靠，所以需要采用无线连接的方式。
无线连接也有两种方式可以选择。一种是Android11及以上的无线调试功能，这个功能我用着不是很稳定，况且对系统有限制，所以我使用第二种方法。第二种方法则是使用ADB WI-FI这个插件，可以直接在插件市场下载安装。下图就是它的详情图。<figure><picture class="mx-auto my-0 rounded-md"><source srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi_hu15442713671799381545.webp 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi_hu735392842479670477.webp 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi_hu4792012550016215299.webp 822w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi_hu4792012550016215299.webp 822w" sizes=100vw type=image/webp><img width=822 height=1066 class="mx-auto my-0 rounded-md" alt="adb Wi-Fi" loading=lazy decoding=async src=/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi_hu16148909346628414716.png srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi_hu9775292770984504168.png 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi_hu16148909346628414716.png 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi.png 822w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi.png 822w" sizes=100vw></picture><figcaption class=text-center>ADB Wi-Fi</figcaption></figure>这个插件第一次使用需要先用数据线连接成功一次，点击屏幕右侧的Wi-Fi图标后页面会显示如下<figure><picture class="mx-auto my-0 rounded-md"><source srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi%20no%20device%20connected_hu7122000307785261281.webp 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi%20no%20device%20connected_hu16676159757827291859.webp 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi%20no%20device%20connected_hu9795437890836047099.webp 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi%20no%20device%20connected_hu6509426226124795222.webp 1076w" sizes=100vw type=image/webp><img width=1076 height=1136 class="mx-auto my-0 rounded-md" alt="adb Wi-Fi no device connect" loading=lazy decoding=async src=/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi%20no%20device%20connected_hu753898940375417646.png srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi%20no%20device%20connected_hu15436819717325159104.png 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi%20no%20device%20connected_hu753898940375417646.png 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi%20no%20device%20connected_hu5343957964770356028.png 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi%20no%20device%20connected.png 1076w" sizes=100vw></picture><figcaption class=text-center>ADB Wi-Fi no device connected</figcaption></figure>它会显示两个设备，一个显示信号图标代表有线连接，一个显示Wi-Fi图标，代表无线连接。现在需要点击带有Wi-Fi图标设备右侧对应的connect按钮，开始连接。连接完成后，页面状态会变成Disconnect,显示如下<figure><picture class="mx-auto my-0 rounded-md"><source srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi%20connected%20a%20device_hu13108464419711832032.webp 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi%20connected%20a%20device_hu11752774611748257366.webp 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi%20connected%20a%20device_hu10579237283434009181.webp 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi%20connected%20a%20device_hu17396940255916960380.webp 1076w" sizes=100vw type=image/webp><img width=1076 height=1136 class="mx-auto my-0 rounded-md" alt="adb Wi-Fi connnected a device" loading=lazy decoding=async src=/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi%20connected%20a%20device_hu3288020292062024895.png srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi%20connected%20a%20device_hu1424295582182547470.png 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi%20connected%20a%20device_hu3288020292062024895.png 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi%20connected%20a%20device_hu2596381540298179210.png 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20Wi-Fi%20connected%20a%20device.png 1076w" sizes=100vw></picture><figcaption class=text-center>adb Wi-Fi connnected a device</figcaption></figure>这时候就代表设备连接成功了。移除数据线，再次运行<code>adb devices</code>命令，会显示已经连接的设备。结果类似于下图这种<figure><picture class="mx-auto my-0 rounded-md"><source srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20devices%20command_hu6974142891576503149.webp 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20devices%20command_hu5924656702488863954.webp 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20devices%20command_hu14180893446170022563.webp 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20devices%20command_hu12761430981142511050.webp 1132w" sizes=100vw type=image/webp><img width=1132 height=108 class="mx-auto my-0 rounded-md" alt="adb devices command" loading=lazy decoding=async src=/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20devices%20command_hu461431289447161146.png srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20devices%20command_hu9731077936867018761.png 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20devices%20command_hu461431289447161146.png 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20devices%20command_hu14932742278956815081.png 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/adb%20devices%20command.png 1132w" sizes=100vw></picture><figcaption class=text-center>adb devices command</figcaption></figure>这种就代表adb准备完成了。</p><h3 id=python脚本准备 class="relative group">Python脚本准备 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#python%e8%84%9a%e6%9c%ac%e5%87%86%e5%a4%87 aria-label>#</a></span></h3><p>由于每个指标都是通过adb命令获取的，结果也会通过adb回显，执行一次命令得到一个指标数据。这些都是固定且重复的工作，可以将它们放到脚本中，我们先来分析一下脚本的结构。
为了明确脚本任务，我们先来分析场景——在测试的某一时刻，脚本需要执行一个adb命令，命令执行完成后，读取输出，然后解析输出，最后将解析结果保存在csv文件中。
这个过程有以下几个可变的内容：</p><ol><li>命令。指标不同，命令自然也不同</li><li>输出。输出结果可能有很多行，也可能只有一个数</li><li>解析。由于结果不同，获取指标有效数据的方法自然也不同
以下几个是固定的内容</li><li>命令执行</li><li>输出结果读取</li><li>解析结果保存
根据对这几个可变和不可变任务的分解，我们可以将任务分解为多个步骤，然后通过继承和重写实现。</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Record</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>file</span><span class=p>,</span><span class=n>cmd</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>file</span><span class=o>=</span><span class=n>file</span>  <span class=c1># csv file name</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cmd</span><span class=o>=</span><span class=n>cmd</span>    <span class=c1># adb command</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>write_title</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>origin</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>title</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>header</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;Timestamp&#39;</span><span class=p>,</span><span class=o>*</span><span class=n>origin</span><span class=p>)</span>    <span class=c1>#table header</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>write</span><span class=p>([</span><span class=n>header</span><span class=p>],</span><span class=s1>&#39;w&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>execute</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># execute adb command and fetch result</span>
</span></span><span class=line><span class=cl>        <span class=n>records</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>fetch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>records</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>records</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>write</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>rows</span><span class=p>,</span><span class=n>mode</span><span class=o>=</span><span class=s1>&#39;a&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># write data to csv file</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>file</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=n>mode</span><span class=p>,</span> <span class=n>newline</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>writer</span> <span class=o>=</span> <span class=n>csv</span><span class=o>.</span><span class=n>writer</span><span class=p>(</span><span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>writer</span><span class=o>.</span><span class=n>writerows</span><span class=p>(</span><span class=n>rows</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>fetch</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># fetch data from adb</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>adb</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>compose</span><span class=p>(</span><span class=n>lines</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>([</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&#34;%Y-%m-</span><span class=si>%d</span><span class=s2> %H:%M:%S&#34;</span><span class=p>),</span><span class=o>*</span><span class=n>line</span><span class=p>]</span> <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>compose</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>lines</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># compose data</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>c</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>convert</span><span class=p>(</span><span class=n>line</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>c</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>yield</span> <span class=n>c</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>title</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># csv header</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>adb</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>cmd</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># execute adb command</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>((</span><span class=n>cmd</span> <span class=k>if</span> <span class=n>cmd</span> <span class=k>else</span> <span class=bp>self</span><span class=o>.</span><span class=n>cmd</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>(),</span> <span class=n>capture_output</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span><span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>=</span><span class=n>result</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=o>.</span><span class=n>splitlines</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>convert</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>line</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># convert line to csv row</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=n>line</span><span class=p>]</span>
</span></span></code></pre></div><p><code>Record</code>是个抽象类，它定义了脚本的流程，包括命令执行、结果读取、结果解析等。它还定义了几个抽象方法，供子类实现。着重需要关注的是<code>execute</code>方法，它定义了整个工作流程，组合了命令执行、结果读取、结果解析等步骤。另一个则是<code>title</code>和<code>convert</code>方法，它们都是通用实现，需要子类重写。</p><h2 id=cpu占用率 class="relative group">CPU占用率 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#cpu%e5%8d%a0%e7%94%a8%e7%8e%87 aria-label>#</a></span></h2><p>最容易也最方便获取的指标就是CPU占用率，可以使用<code>top</code>命令或者<code>dumpsys cpuinfo</code>命令。<code>top</code>命令给出的数据比较直观，所以使用它来说明。
但是如果直接运行<code>adb shell top</code>命令，则命令会一直运行，过一秒刷新一次数据，直到手动停止。在运行脚本的时候，我们希望它刷新一次后马上退出，所以，需要查看一下它的帮助文档。帮助文档输出如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>Toybox 0.8.9-android multicall binary <span class=o>(</span>see toybox --help<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>usage: top <span class=o>[</span>-Hhbq<span class=o>]</span> <span class=o>[</span>-k FIELD,<span class=o>]</span> <span class=o>[</span>-o FIELD,<span class=o>]</span> <span class=o>[</span>-s SORT<span class=o>]</span> <span class=o>[</span>-n NUMBER<span class=o>]</span> <span class=o>[</span>-m LINES<span class=o>]</span> <span class=o>[</span>-d SECONDS<span class=o>]</span> <span class=o>[</span>-p PID,<span class=o>]</span> <span class=o>[</span>-u USER,<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Show process activity in real time.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-H	Show threads
</span></span><span class=line><span class=cl>-h	Usage graphs instead of text
</span></span><span class=line><span class=cl>-k	Fallback sort FIELDS <span class=o>(</span>default -S,-%CPU,-ETIME,-PID<span class=o>)</span>
</span></span><span class=line><span class=cl>-o	Show FIELDS <span class=o>(</span>def PID,USER,PR,NI,VIRT,RES,SHR,S,%CPU,%MEM,TIME+,CMDLINE<span class=o>)</span>
</span></span><span class=line><span class=cl>-O	Add FIELDS <span class=o>(</span>replacing PR,NI,VIRT,RES,SHR,S from default<span class=o>)</span>
</span></span><span class=line><span class=cl>-s	Sort by field number <span class=o>(</span>1-X, default 9<span class=o>)</span>
</span></span><span class=line><span class=cl>-b	Batch mode <span class=o>(</span>no tty<span class=o>)</span>
</span></span><span class=line><span class=cl>-d	Delay SECONDS between each cycle <span class=o>(</span>default 3<span class=o>)</span>
</span></span><span class=line><span class=cl>-m	Maximum number of tasks to show
</span></span><span class=line><span class=cl>-n	Exit after NUMBER iterations
</span></span><span class=line><span class=cl>-p	Show these PIDs
</span></span><span class=line><span class=cl>-u	Show these USERs
</span></span><span class=line><span class=cl>-q	Quiet <span class=o>(</span>no header lines<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Cursor UP/DOWN or LEFT/RIGHT to move list, SHIFT LEFT/RIGHT to change sort,
</span></span><span class=line><span class=cl>space to force update, R to reverse sort, Q to exit.
</span></span></code></pre></div><p>可以看到它提供了<code>-n</code>参数，命令将在循环<code>n</code>次数后退出。所以，我们只需要设置这个参数为1，就可以获取一次数据后马上退出，由此最终的命令就确定了——<code>adb shell top -n 1</code>。</p><p>得到了命令，再来看看输出。输出其实比较直观，由于输出内容中有表头，我们只需要根据表头找到合适的列，然后获取列的值。注意到表头中有个<code>[%cpu]</code>的列，所以它很显然就代表CPU占用率。但是哪一行才是测试应用占用的百分比呢？通过观察输出值，我们发现<code>args</code>参数的值很适合用来区分——它的值是应用的包名。所以，通过<code>args</code>查找到测试应用到行后，在读取<code>[%cpu]</code>列的值，就可以获取到应用占用的百分比。
啰嗦了这么多，并不是说这个问题有多难，只是想通过具体的例子展示思考的过程。因为后面的很多指标都是通过类似的方法，经过相同的步骤分析出来的。<em><strong>首先找到合适的命令，然后通过命令的帮助文档添加合适的限定参数，执行命令，观察命令输出，然后根据输出结果，定位到合适的行，找到最终的值。</strong></em>
有了命令和输出数据，就可以完善脚本了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>CPURecord</span><span class=p>(</span><span class=n>Record</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>file</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>file</span><span class=p>,</span><span class=s1>&#39;adb shell top -n 1 | grep com.xxx&#39;</span><span class=p>)</span> <span class=c1>#xxx represent package name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>title</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;CPU Usage (%)&#34;</span><span class=p>]</span>    <span class=c1># csv header</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>convert</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>line</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>parts</span> <span class=o>=</span> <span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cpu_usage</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>parts</span><span class=p>[</span><span class=mi>8</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;%&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>[</span><span class=n>cpu_usage</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=p>(</span><span class=ne>ValueError</span><span class=p>,</span> <span class=ne>IndexError</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span></code></pre></div><p><code>CPURecord</code>重写了两个方法，相应的说明已经在上面的内容提过了。</p><h2 id=gpu占用率 class="relative group">GPU占用率 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#gpu%e5%8d%a0%e7%94%a8%e7%8e%87 aria-label>#</a></span></h2><p>GPU占用率，网上很多文章都是说通过<code>adb shell dumpsys gfxinfo xxx</code>命令获取，但是这个命令在并不能获取到GPU占用率，只能获取到GPU的帧信息。所以我们要使用其他方法。几经搜索尝试。发现并没有合适的命令，却有个好用的工具<a href=www.qualcomm.com/developer/software/snapdragon-profiler>snapdragon profiler</a></p><h3 id=snapdragon-profiler-使用 class="relative group">Snapdragon Profiler 使用 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#snapdragon-profiler-%e4%bd%bf%e7%94%a8 aria-label>#</a></span></h3><p>Snapdragon Profiler不仅能获取到CPU，GPU等多种信息，还有着丰富的配置选项，可以满足很多指标数据的获取。但是需要注意的是，有些配置项会随着当前所连接的设备的系统版本的不同而不同。如在我的测试中，Android 9就没有GPU Busy这一项，而Android 14的系统是显示完整的。
本次示例中只要获取GPU的占用率，也就是GPU Busy这个
打开Snapdragon Profiler，很多配置都是灰色的，需要首先连接设备。<figure><picture class="mx-auto my-0 rounded-md"><source srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%202_hu2838942725106841401.webp 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%202_hu5747558064314883493.webp 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%202_hu433865342607037595.webp 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%202_hu14842108732566442871.webp 1282w" sizes=100vw type=image/webp><img width=1282 height=832 class="mx-auto my-0 rounded-md" alt="Snapdragon profiler no device connect" loading=lazy decoding=async src=/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%202_hu3890618270687233334.png srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%202_hu17221978616780874165.png 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%202_hu3890618270687233334.png 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%202_hu7507850335059430773.png 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%202.png 1282w" sizes=100vw></picture><figcaption class=text-center>Snapdragon profiler no device connect</figcaption></figure>点击<code>Start a Session</code>，如果此时连着Android设备，则会显示如下界面<figure><picture class="mx-auto my-0 rounded-md"><source srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%203_hu6903023972561518705.webp 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%203_hu2220413975750991916.webp 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%203_hu6027955576182770600.webp 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%203_hu4118174662754129017.webp 1282w" sizes=100vw type=image/webp><img width=1282 height=832 class="mx-auto my-0 rounded-md" alt="Snapdragon profiler device avaliable" loading=lazy decoding=async src=/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%203_hu2296145044234017615.png srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%203_hu2606611780710915703.png 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%203_hu2296145044234017615.png 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%203_hu10891900801242764942.png 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%203.png 1282w" sizes=100vw></picture><figcaption class=text-center>Snapdragon profiler device avaliable</figcaption></figure>点击<code>Connect</code>开始连接<figure><picture class="mx-auto my-0 rounded-md"><source srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%204_hu18195408080822673336.webp 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%204_hu6980403307582367643.webp 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%204_hu14640817154085454336.webp 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%204_hu11802939769576425524.webp 1282w" sizes=100vw type=image/webp><img width=1282 height=832 class="mx-auto my-0 rounded-md" alt="Snapdragon profiler connect device" loading=lazy decoding=async src=/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%204_hu3647413971082285858.png srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%204_hu1816997278271470096.png 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%204_hu3647413971082285858.png 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%204_hu8331357725044986454.png 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%204.png 1282w" sizes=100vw></picture><figcaption class=text-center>Snapdragon profiler connect device</figcaption></figure>等待几秒钟，如果一切顺利，下面三个选项则会变为可用<figure><picture class="mx-auto my-0 rounded-md"><source srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%205_hu2523589602797267804.webp 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%205_hu8230529767909053156.webp 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%205_hu11983944233320103268.webp 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%205_hu18296107126875272409.webp 1282w" sizes=100vw type=image/webp><img width=1282 height=832 class="mx-auto my-0 rounded-md" alt="Snapdragon profiler avaliable options" loading=lazy decoding=async src=/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%205_hu347646707890263821.png srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%205_hu7284110804132092228.png 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%205_hu347646707890263821.png 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%205_hu14391647088308233289.png 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%205.png 1282w" sizes=100vw></picture><figcaption class=text-center>Snapdragon profiler avaliable options</figcaption></figure>选择第二项Realtime performance analysis,在筛选框中输入包名来选取目标应用<figure><picture class="mx-auto my-0 rounded-md"><source srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%206_hu12779368918538362127.webp 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%206_hu10102889575565668485.webp 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%206_hu10809139638708590051.webp 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%206_hu4625613879281134652.webp 1283w" sizes=100vw type=image/webp><img width=1283 height=832 class="mx-auto my-0 rounded-md" alt="Snapdragon profiler realtime performance analysis" loading=lazy decoding=async src=/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%206_hu9427697287625895852.png srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%206_hu11822437584302785865.png 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%206_hu9427697287625895852.png 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%206_hu13657913040361782560.png 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%206.png 1283w" sizes=100vw></picture><figcaption class=text-center>Snapdragon profiler realtime performance analysis</figcaption></figure>然后在下面的框中双击对应的GPU Busy指标<figure><picture class="mx-auto my-0 rounded-md"><source srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%207_hu16378974354096622047.webp 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%207_hu12455890229768373343.webp 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%207_hu5366570990279529643.webp 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%207_hu14696548415799194654.webp 1282w" sizes=100vw type=image/webp><img width=1282 height=832 class="mx-auto my-0 rounded-md" alt="Snapdragon profiler filter" loading=lazy decoding=async src=/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%207_hu11667907024276629048.png srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%207_hu14449194050682722034.png 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%207_hu11667907024276629048.png 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%207_hu12226357261298337541.png 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%207.png 1282w" sizes=100vw></picture><figcaption class=text-center>Snapdragon profiler filter</figcaption></figure>页面的右上方就会实时绘制出当前应用的GPU占用率。<figure><picture class="mx-auto my-0 rounded-md"><source srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%208_hu6059773649405970302.webp 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%208_hu2909563224776800968.webp 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%208_hu15720464770106851969.webp 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%208_hu11216329686035103516.webp 1282w" sizes=100vw type=image/webp><img width=1282 height=832 class="mx-auto my-0 rounded-md" alt="Snapdragon profiler gpu busy" loading=lazy decoding=async src=/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%208_hu5152441550887369464.png srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%208_hu14400634125382452324.png 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%208_hu5152441550887369464.png 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%208_hu6309259683892629240.png 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%208.png 1282w" sizes=100vw></picture><figcaption class=text-center>Snapdragon profiler gpu busy</figcaption></figure>如果需要导出数据，则点击如下的按钮<figure><picture class="mx-auto my-0 rounded-md"><source srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%209_hu2696896446232915907.webp 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%209_hu15462476826602977035.webp 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%209_hu16769424813388276035.webp 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%209_hu14140482673298015116.webp 1282w" sizes=100vw type=image/webp><img width=1282 height=832 class="mx-auto my-0 rounded-md" alt="Snapdragon profiler export" loading=lazy decoding=async src=/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%209_hu11194188657334387448.png srcset="/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%209_hu15579233039714097754.png 330w,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%209_hu11194188657334387448.png 660w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%209_hu4389399925591161179.png 1024w
,/posts/a-guide-for-performance-testing-of-android-real-time-applications/Snapdragon%20Profiler%209.png 1282w" sizes=100vw></picture><figcaption class=text-center>Snapdragon profiler export</figcaption></figure>然后导出为csv文件，可以直接使用里面的数据，也可用Python再做一次解析。</p><h2 id=内存占用率 class="relative group">内存占用率 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%86%85%e5%ad%98%e5%8d%a0%e7%94%a8%e7%8e%87 aria-label>#</a></span></h2><p>内存占用率，对应的命令<code>adb shell dumpsys meminfo com.xxx</code>命令获取。由于直接通过命令指定来应用包名，所以输出信息只是关于指定应用的，不需要再筛选。在此有个关于<code>adb shell dumpsys</code>命令的小技巧，<em><strong>如果命令最后指定一个应用包名就可以将数据限定在指定的应用内。</strong></em>
这个命令的输出直接包含TOTAL这一行，所以只需要读取这一行，然后根据格式解析即可。需要注意的是，不同的设备输出会有细微差别，针对输出再做调整即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>MemoryRecord</span><span class=p>(</span><span class=n>Record</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>file</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>file</span><span class=p>,</span><span class=s1>&#39;adb shell dumpsys meminfo com.xxx&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>title</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;Memory Total (MB)&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>convert</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>line</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;TOTAL&#34;</span> <span class=ow>in</span> <span class=n>line</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>contents</span><span class=o>=</span><span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>memory_total</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>contents</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=mi>1024</span>  <span class=c1># 转换为MB</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>[</span><span class=n>memory_total</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=p>(</span><span class=ne>ValueError</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span></code></pre></div><h2 id=比特率和帧率 class="relative group">比特率和帧率 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%af%94%e7%89%b9%e7%8e%87%e5%92%8c%e5%b8%a7%e7%8e%87 aria-label>#</a></span></h2><p>由于要测试的是音视频应用，所以比特率和帧率是重点。但是这些数据都是应用内数据，通过外部工具很难获取，或者获取的数据不够准确。所以这里采用一种新的方式，在应用内收集数据，再通过某种方式将数据发送出来。当时我想到的方法有应用内文件记录和日志打印。由于担心日志记录的方式对应用中CPU和内容测试有影响，所以最终选择了日志打印的方式。日志打印的方式，在应用中添加一个日志打印模块，然后将收集到的数据通过日志打印出来，最后通过adb logcat命令获取日志，然后解析日志，将有效的结果保存在csv文件中。
通过实测，这种方式是可行的，但是要做好数据筛选，不然容易造成数据重复或者丢失。这里我选择的数据筛选方式是指定<code>-T</code>参数，它能指定输出数据在某个时刻之后。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>FPSRecord</span><span class=p>(</span><span class=n>Record</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>file</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>file</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>pat</span><span class=o>=</span><span class=sa>r</span><span class=s1>&#39;Frame reports\((.+)\)\:Frames received = (\d+),Frames lost = (\d+),Frame render = (\d+)&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>title</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;User&#34;</span><span class=p>,</span><span class=s2>&#34;Received fps&#34;</span><span class=p>,</span><span class=s2>&#34;Render fps&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>execute</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>format_cmd</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>execute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>convert</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>line</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>match</span><span class=o>=</span><span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>pat</span><span class=p>,</span><span class=n>line</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=k>match</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>(</span><span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span><span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>2</span><span class=p>),</span><span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>format_cmd</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cmd</span><span class=o>=</span><span class=s1>&#39;adb logcat -T </span><span class=si>{}</span><span class=s1> -d tag:V *:S&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>cmd</span><span class=p>)</span>
</span></span></code></pre></div><p>这里只列举了FPSRecord，其他类似。</p><h2 id=温度变化 class="relative group">温度变化 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%b8%a9%e5%ba%a6%e5%8f%98%e5%8c%96 aria-label>#</a></span></h2><p>Android中温度的范围很广，CPU温度，相机温度，屏幕温度，外壳温度，电池温度，还有各种传感器温度。有一些能通过命令读取，有一些则不能。当然更科学和准确的数据可能需要借助仪器。这里我只对命令能获取的温度做了了解。
在Android系统中，能产生热量的部件都会将数据记录在<code>/sys/class/thermal/</code>目录下，并以<code>thermal_zone</code>作为目录名的前缀。每个目录下会有两个文件，<code>type</code>记录热源名字，<code>temp</code>记录温度值。在我的测试中，我想记录所有的热源数据，所以需要使用<code>ls</code>遍历这个目录。
在每次执行命令时，依次读取这些目录和文件，并将名字和温度值对应保存在一起，就可以得到最终的温度数据了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>TemperatureRecord</span><span class=p>(</span><span class=n>Record</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>file</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>zones</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>adb</span><span class=p>(</span><span class=s2>&#34;adb shell ls /sys/class/thermal/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>zones</span><span class=o>=</span><span class=p>[</span><span class=n>temp</span> <span class=k>for</span> <span class=n>temp</span> <span class=ow>in</span> <span class=n>zones</span> <span class=k>if</span> <span class=n>temp</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;thermal_zone&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=n>temps_types</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;cat /sys/class/thermal/</span><span class=si>{}</span><span class=s2>/type&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>temp</span><span class=p>)</span> <span class=k>for</span> <span class=n>temp</span> <span class=ow>in</span> <span class=n>zones</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>temps_values</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;cat /sys/class/thermal/</span><span class=si>{}</span><span class=s2>/temp&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>temp</span><span class=p>)</span> <span class=k>for</span> <span class=n>temp</span> <span class=ow>in</span> <span class=n>zones</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>types</span><span class=o>=</span><span class=s1>&#39;;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>temps_types</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>values</span><span class=o>=</span><span class=s1>&#39;;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>temps_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cmd_types</span><span class=o>=</span><span class=s2>&#34;adb shell </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>types</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cmd_value</span><span class=o>=</span><span class=s2>&#34;adb shell </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>file</span><span class=p>,</span><span class=n>cmd_value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cmd_title</span><span class=o>=</span><span class=n>cmd_types</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>zones</span><span class=o>=</span><span class=n>zones</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>title</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>types</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>adb</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>cmd_title</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>zone</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>t</span><span class=si>}</span><span class=s2>)&#34;</span> <span class=k>for</span> <span class=n>zone</span><span class=p>,</span><span class=n>t</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>zones</span><span class=p>,</span><span class=n>types</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>compose</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>lines</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>temp</span><span class=p>)</span> <span class=o>/</span> <span class=mi>1000</span> <span class=k>for</span> <span class=n>temp</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=耗电量 class="relative group">耗电量 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e8%80%97%e7%94%b5%e9%87%8f aria-label>#</a></span></h2><p>耗电量通过命令<code>adb shell dumpsys battery</code>获取，和之前一样的分析和处理过程，在次不再赘述，直接给出脚本。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>BatteryRecord</span><span class=p>(</span><span class=n>Record</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>file</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>file</span><span class=p>,</span><span class=s1>&#39;adb shell dumpsys battery&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>title</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=s2>&#34;Battery Level (%)&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>convert</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>line</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;level&#34;</span> <span class=ow>in</span> <span class=n>line</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>battery_level</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>[</span><span class=n>battery_level</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span></code></pre></div><h2 id=融合起来 class="relative group">融合起来 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e8%9e%8d%e5%90%88%e8%b5%b7%e6%9d%a5 aria-label>#</a></span></h2><p>现在我们确定的指标数据都定义好了，但是还没组装起来，使用起来不方便。理想的情况是，执行一次脚本，各个指标每隔一定的时间间隔执行一次，直到某种条件触发，脚本停止。所以需要找一个条件，能让应用运行时脚本一直运行。</p><h3 id=判断应用是否退出 class="relative group">判断应用是否退出 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%88%a4%e6%96%ad%e5%ba%94%e7%94%a8%e6%98%af%e5%90%a6%e9%80%80%e5%87%ba aria-label>#</a></span></h3><p>众所周知，Android有四大组件，Activity，Service，BroadcastReceiver和ContentProvider。但是，在Android中，Activity是唯一能直接和用户进行交互的组件，所以，判断应用是否退出，就意味着判断Activity是否退出。而恰巧的是<code>dumpsys</code>有<code>activity</code>命令。通过指定包名，观察输出，发现只要判断是否有对应的Activity就可以判断应用是否退出了。
判断方式如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>can_be_continue</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>adb</span><span class=p>(</span><span class=s1>&#39;adb shell dumpsys activity -p &#34;</span><span class=si>{}</span><span class=s1>&#34; r&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>PACKAGE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>l</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s2>&#34;Activities&#34;</span> <span class=ow>in</span> <span class=n>l</span> <span class=ow>and</span> <span class=n>PACKAGE</span> <span class=ow>in</span> <span class=n>l</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span></code></pre></div><h3 id=判断应用是否处在前台 class="relative group">判断应用是否处在前台 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%88%a4%e6%96%ad%e5%ba%94%e7%94%a8%e6%98%af%e5%90%a6%e5%a4%84%e5%9c%a8%e5%89%8d%e5%8f%b0 aria-label>#</a></span></h3><p>而应用在前台也是类似的，Activity是一种方式，但是不好找判断条件。而和Activity类似的还有窗口，所以，判断应用是否处在前台，就意味着判断窗口是否处于前台。通过<code>dumpsys window</code>命令，可以获取窗口信息，通过筛选<code>mFocusedApp</code>属性的窗口，并比较包名就能确定应用是否在前台。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>lines</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>adb</span><span class=p>(</span><span class=s1>&#39;adb shell dumpsys window d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>l</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;mFocusedApp&#39;</span> <span class=ow>in</span> <span class=n>l</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>PACKAGE</span> <span class=ow>in</span> <span class=n>l</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span></code></pre></div><h3 id=多线程执行 class="relative group">多线程执行 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%a4%9a%e7%ba%bf%e7%a8%8b%e6%89%a7%e8%a1%8c aria-label>#</a></span></h3><p>循环条件找到了，但是根据实测，发现有些命令执行比较耗时，为了能在短时间内获取数据，需要将各个指标的命令执行放在多线程中。同时为了保证每个命令执行的时间间隔尽可能相同，所以需要测量执行命令的时间，然后根据时间间隔选取合适的休眠时间。由此，整个脚本就串起来了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=n>record</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>record</span><span class=o>.</span><span class=n>can_be_continue</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>before</span><span class=o>=</span><span class=n>time</span><span class=o>.</span><span class=n>time_ns</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>record</span><span class=o>.</span><span class=n>execute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>usage</span><span class=o>=</span><span class=n>time</span><span class=o>.</span><span class=n>time_ns</span><span class=p>()</span><span class=o>-</span><span class=n>before</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>usage</span><span class=o>&gt;=</span><span class=n>S_UNIT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>usage</span><span class=o>/</span><span class=n>S_UNIT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>records</span><span class=o>=</span><span class=p>[</span><span class=n>MemoryRecord</span><span class=p>(</span><span class=s2>&#34;memory_stats.csv&#34;</span><span class=p>),</span><span class=n>CPURecord</span><span class=p>(</span><span class=s1>&#39;cpu_stats.csv&#39;</span><span class=p>),</span><span class=n>FPSRecord</span><span class=p>(</span><span class=s1>&#39;fps_stats.csv&#39;</span><span class=p>),</span><span class=n>NetworkRecord</span><span class=p>(</span><span class=s1>&#39;network_stats.csv&#39;</span><span class=p>),</span><span class=n>BatteryRecord</span><span class=p>(</span><span class=s1>&#39;battery_stats.csv&#39;</span><span class=p>),</span><span class=n>TemperatureRecord</span><span class=p>(</span><span class=s1>&#39;temperature_stats.csv&#39;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>#init </span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>record</span> <span class=ow>in</span> <span class=n>records</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>record</span><span class=o>.</span><span class=n>write_title</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>threads</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>record</span> <span class=ow>in</span> <span class=n>records</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>=</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>run</span><span class=p>,</span><span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>record</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>        <span class=n>threads</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>thread</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>thread</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span></code></pre></div><h2 id=总结 class="relative group">总结 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%80%bb%e7%bb%93 aria-label>#</a></span></h2><p>性能测试有很多指标项，不同的指标项需要不同的处理方法。CPU，内存，电池可以直接通过<code>dumpsys</code>命令获取。而GPU数据目前我没有找到没有合适的命令，目前比较完备的解决方案是使用第三方工具：Snapdragon Profiler，但这个工具也对低版本的系统有限制。Python用来处理这些数据是个很好的选择，不仅有字符串，正则这些很强的工具可以用，还可以异步处理，是个性能测试的好帮手。</p><h2 id=参考链接 class="relative group">参考链接 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5 aria-label>#</a></span></h2><ol><li><a href=https://developer.android.com/tools/dumpsys target=_blank rel=noreferrer>dumpsys</a></li><li><a href=www.qualcomm.com/developer/software/snapdragon-profiler>snapdragon profiler</a></li><li><a href=https://github.com/hongui/RealtimePerformanceTest.git target=_blank rel=noreferrer>script</a></li></ol></div></section><footer class="max-w-prose pt-8 print:hidden"><div class=flex><picture class="!mb-0 !mt-0 me-4 w-24 h-auto rounded-full"><img width=1000 height=1000 class="!mb-0 !mt-0 me-4 w-24 h-auto rounded-full" alt=低头沉思 loading=lazy decoding=async src=/images/logo_hu1444715804356428735.png srcset="/images/logo_hu10122803172005691567.png 330w,/images/logo_hu1444715804356428735.png 660w
,/images/logo.png 1000w
,/images/logo.png 1000w" sizes=100vw></picture><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400"></div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">低头沉思</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=mailto:honguilee@163.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg>
</span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://github.com/hongui target=_blank aria-label=Github rel="me noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/posts/learning-opengles-on-the-android-fill-the-window/><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Android-OpenGLES学习-画个颜色</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2023-05-09 22:14:38 +0800 +0800"></time>
</span></span></a></span><span></span></div></div></footer></article></main><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12" id=to-top hidden=true><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label title>&uarr;</a></div><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2024
低头沉思</p><p class="text-xs text-neutral-500 dark:text-neutral-400"></p></div><div class="flex flex-row items-center"></div></div></footer><div id=search-wrapper class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://deep-thinking.top/><div id=search-modal class="top-20 mx-auto flex min-h-0 w-full max-w-3xl flex-col rounded-md border border-neutral-200 bg-neutral shadow-lg dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex flex-none items-center justify-between px-2"><form class="flex min-w-0 flex-auto items-center"><div class="flex h-8 w-8 items-center justify-center text-neutral-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="mx-1 flex h-12 flex-auto appearance-none bg-transparent focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder tabindex=0></form><button id=close-search-button class="flex h-8 w-8 items-center justify-center text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title>
<span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto overflow-auto px-2"><ul id=search-results></ul></section></div></div></div></body></html>